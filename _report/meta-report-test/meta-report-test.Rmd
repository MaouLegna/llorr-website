---
title: "THE TESTING META REPORT NAME IS TOO LONG, IT IS EVEN LONGER!!!"
description: |
  Quick testing page for CSS / Format / Functions and other stuff.
base_url: https://llorr-stats.netlify.app
preview:   
author:
  - name: Valentino (Legna) Vazzoler
date: 12-06-1986
output:
 distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 2
    self_contained: false
citation: false
draft: true
twitter:
  site: "@Maou_Legna"
  creator: "@Maou_Legna"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  comment = NA,
  R.options = list(width = 140,
                   digits.secs=6),
  dev.args = list(bg = 'transparent'), # make graphics with transparent background
  fig.align = 'center',
  fig.width=9,
  fig.height=6,
  engine.path = list(
    python = 'C:/anaconda/'   # -> use_python("C:/anaconda/")
  ),
  #'distill options
  layout="l-body-outset",
  preview=FALSE
)

#' R Option
source(file.path("C:","LlorR","scripts","lor_main.R" ))

# require(Hmisc)    # provides knitrSet and other functions
xaringanExtra::use_panelset()
#' Python
# py_run_string("print('Hello World')")
# lor_deckcodes <- import("lor_deckcodes")
# py_module_available("lor_deckcodes")
```

```{r panelset-style}
xaringanExtra::style_panelset_tabs(font_family = "Roboto",
                                   active_foreground = "white",
                                   hover_foreground = "black",
                                   hover_border_color = "black",
                                   active_background = "#007fff"
                                   )
```

```{r raw-data}
#' load Account
#'#############
file.Account <- file.path("C:","LlorR","data","raw","LoR_ACCOUNT.csv")
LoR.Account.RMD <- fread(file.Account, header=T, na.strings = c("",NA), encoding = 'UTF-8') %>%
  mutate( RiotID = paste(gameName,tagLine),refID = puuid_4 ) %>%
  pivot_longer(
  cols = c("puuid_1","puuid_2","puuid_3","puuid_4"),
  names_to = "origin",
  values_to = "puuid"
)

#' load DeckDT
#'############
LoR.Deck        <- fread(file.path("C:","LlorR","data","raw","LoR_DECK.csv"),na.strings = c("",NA))

#' load gameDT
#'############
file.DT <- file.path("C:","LlorR","data","raw","LoR_MatchDT.csv")
# header        <- fread(file.DT, header = FALSE, na.strings = c("",NA), nrows = 1, stringsAsFactors = FALSE)
fread(file.path("C:","LlorR","data","raw","LoR_MatchDT.csv"), header = T, na.strings = c("", NA))
```

```{r prepare-data}
LoR.Ranked.RMD <- fread(file.path("C:","LlorR","data","raw","LoR_MatchDT.csv"), header = T, na.strings = c("", NA)) %>%
  #' Base filters
  filter( game_type=="Ranked" ) %>%
  # filter( game_start_time_utc >= as.POSIXct(params$prev, tz = "UTC") & game_start_time_utc < as.POSIXct(params$start, tz = "UTC") ) %>%
  #' 'process' data
  left_join(.,LoR.Deck[,.(deck_code,archetype)] %>% setnames(old = "archetype", new = "player_1")   ,by=c("deck_code_1"="deck_code")) %>%
  left_join(.,LoR.Deck[,.(deck_code,archetype)] %>% setnames(old = "archetype", new = "opponent_1") ,by=c("deck_code_2"="deck_code")) %>%
  mutate( player_2 = opponent_1, opponent_2 = player_1, oppoppuid_1 = puuid_2, oppoppuid_2 = puuid_1 ) %>%
  select( match_key,server,game_start_time_utc,game_version,total_turn_count,
          ends_with("_1"),ends_with("_2"),-ends_with("_3"),-ends_with("_4"),-contains("deck_id"),-contains("participants") ) %>%
  #' melt data
  melt(id.vars=c("match_key","server","game_start_time_utc","game_version","total_turn_count"), measure.vars=patterns(
    str_sub(
      names(select(.,ends_with("_1")))
      ,end = -3)
  ),
  value.name = str_sub(
    names(select(.,ends_with("_1")))
    ,end = -3)
  ) %>%
  #' finish 'process' data
  left_join(. , LoR.Account.RMD[,c("puuid","RiotID","refID")] %>% setnames(old = "RiotID", new = "userID")     ,by=c("puuid"="puuid")) %>%
  left_join(. , LoR.Account.RMD[,c("puuid","RiotID")] %>% setnames(old = "RiotID", new = "opponentID") ,by=c("oppoppuid"="puuid")) %>%
  # left_join(.,LoR.Deck %>% select(!archetype),by=c("deck_code","factions")) %>%
  select(-ends_with("puuid"),-refID)
```

# section
::: l-page

::::: {.panelset}

::: {.panel}

## History {.panel-name}

```{r}

Region.Freq$freq


calendar <- tibble(start = seq(as.POSIXct("2020-04-29 21:00:00", tz = "UTC"),Sys.time(), by = "7 DSTdays"),
                   end   = start + days(7),
                   index = seq_len(length(start)),
                   label = glue("Week {index}")
                   )

# LoR.Ranked.RMD %>%
#   filter( game_start_time_utc >= as.POSIXct("2021-07-21 21:00:00", tz = "UTC") & game_start_time_utc < as.POSIXct("2021-07-28 21:00:00", tz = "UTC") ) %>%
#   NROW()/2

region.freq.history  <- map2_df( .x = calendar$start, .y = calendar$end, ~get_factions_freq(x = LoR.Ranked.RMD, start = .x ,end = .y,format = "long" )   )
weekly.patch.history <- map2_chr( .x = calendar$start, .y = calendar$end, ~get_patch_main(x = LoR.Ranked.RMD, start = .x ,end = .y )   )
# 
region.history <- cbind(
calendar,
weekly.patch.history,
region.freq.history
) %>%
  rename("patch"="weekly.patch.history") %>%
  rowwise() %>%
  mutate(total = sum(c_across(contains("_n")) ) ) %>%
  group_by(patch) %>%
  mutate(week.patch.index = row_number() ) %>%
  mutate( patch_lbl = case_when(
          !is.na(patch) == T ~ glue("{patch} - Week {week.patch.index}"),
          TRUE ~ patch
          )
  ) %>%
  add_column( sample_size = map2_dbl(.x = calendar$start, .y = calendar$end, .f = ~NROW( LoR.Match.RMD %>% 
                                                            dplyr::filter( game_start_time_utc >= as.POSIXct(.x, tz = "UTC") & game_start_time_utc < as.POSIXct(.y, tz = "UTC") & game_type == "Ranked" )
                                                          ) ) ) %>%
  rowwise() %>%
  mutate(gini = DescTools::Gini( c_across(contains("_freq")),na.rm = T ))

# LoR.Match.RMD %>%
#   dplyr::filter( game_start_time_utc >= as.POSIXct("2021-07-21 21:00:00", tz = "UTC") & game_start_time_utc < as.POSIXct("2021-07-28 21:00:00", tz = "UTC"))

fwrite(region.history,file.path("C:","LlorR","data","clean","Factions_History.csv"))
```
:::::

:::



