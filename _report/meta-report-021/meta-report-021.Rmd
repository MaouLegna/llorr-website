---
title: "THE META REPORT NAME IS TOO LONG, TOO DAMN LONG (n°21)"
description: |
  Patch 2.14 - Week 1 - Rise of the Sion supremacy
base_url: https://llorr-stats.netlify.app
preview: "https://dd.b.pvp.net/latest/set5/en_us/img/cards/05NX001T3-full.png"
author:
  - name: Valentino (Legna) Vazzoler
# date: 09-01-2021
output:
 distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 3
    self_contained: false
citation: false
draft: false
# twitter:
#   site: "@Maou_Legna"
#   creator: "@Maou_Legna"
params:
  prev:  "2021-07-18 21:00:00" #UTC tz / 'previous' week start
  start: "2021-08-25 21:00:00" #UTC tz / 'current' week start
  end:   "2021-09-01 21:00:00" #UTC tz / 'current' week end
  skip:  2800000  # ~ Patch 2.14
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  comment = NA,
  R.options = list(width = 140,
                   digits.secs=6),
  dev.args = list(bg = 'transparent'), # make graphics with transparent background
  fig.align = 'center',
  fig.width=9,
  fig.height=6,
  engine.path = list(
    python = 'C:/anaconda/'   # -> use_python("C:/anaconda/")
  ),
  #'distill options
  layout="l-body-outset",
  preview=FALSE
)

#' R Option
source(file.path("C:","LlorR","scripts","lor_main.R" ))

# require(Hmisc)    # provides knitrSet and other functions
xaringanExtra::use_panelset()
#' Python
py_run_string("print('Hello World')")
lor_deckcodes <- import("lor_deckcodes")
py_module_available("lor_deckcodes")
```

```{r panelset-style}
xaringanExtra::style_panelset_tabs(font_family = "Roboto",
                                   active_foreground = "white",
                                   hover_foreground = "black",
                                   hover_border_color = "black",
                                   active_background = "#007fff"
                                   )
```

```{r twitter-meta, echo = FALSE}
library(metathis)
meta() %>%
  meta_description(
    "Patch 2.14 - Week 1 - Rise of the Sion supremacy"
  ) %>% 
  meta_viewport() %>% 
  meta_social(
    title = "THE META REPORT NAME IS TOO LONG, TOO DAMN LONG (n°21)",
    url = "https://llorr-stats.netlify.app/",
    image = "https://dd.b.pvp.net/latest/set5/en_us/img/cards/05NX001T3-full.png",
    image_alt = "Sion lv2",
    og_type = "website",
    og_author = "Legna",
    twitter_card_type = "summary",
    twitter_creator = "@Maou_Legna"
  )
```

```{r flex-setup}
options(reactable.theme = reactableTheme(
  color = "grey25",
  backgroundColor = NULL,
  borderColor = "#dfe2e5",
  borderWidth = NULL,
  stripedColor = "#f6f8fa",
  highlightColor = "#f0f5f9", 
  cellPadding = "8px 13px", # dimensione del contenuto(?)
  style = list( fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Roboto, sans-serif" ), # font delle varie componenti
  tableStyle = NULL,
  headerStyle = list(background = "steelblue",color="white" ), # ,fontFamily = "Work Sans, sans-serif, fontSize = "14px""
  groupHeaderStyle = NULL,
  tableBodyStyle = NULL,
  rowGroupStyle = NULL,
  rowStyle = NULL,
  rowStripedStyle = NULL,
  rowHighlightStyle = NULL,
  rowSelectedStyle = NULL,
  cellStyle = NULL,
  footerStyle = NULL,
  inputStyle = NULL,
  filterInputStyle = NULL,
  searchInputStyle = list(width = "100%"), # opzioni barra search
  selectStyle = NULL,
  paginationStyle = NULL,
  pageButtonStyle = NULL,
  pageButtonHoverStyle = NULL,
  pageButtonActiveStyle = NULL,
  pageButtonCurrentStyle = NULL
))
```


```{r raw-data}
#' load gameDT
#'############
file.DT <- file.path("C:","LlorR","data","raw","LoR_MatchDT.csv")
header        <- fread(file.DT, header = FALSE, na.strings = c("",NA), nrows = 1, stringsAsFactors = FALSE)
LoR.Match.RMD <- fread(file.DT, header = FALSE, na.strings = c("",NA), skip = params$skip )
colnames(LoR.Match.RMD) <- unlist(header,use.names = F)

#' load Account
#'#############
file.Account <- file.path("C:","LlorR","data","raw","LoR_ACCOUNT.csv")
LoR.Account.RMD <- fread(file.Account, header=T, na.strings = c("",NA), encoding = 'UTF-8') %>%
  mutate( RiotID = paste(gameName,tagLine),refID = puuid_4 ) %>%
  pivot_longer(
  cols = contains("puuid"),
  names_to = "origin",
  values_to = "puuid"
)

#' load DeckDT
#'############
LoR.Deck        <- fread(file.path("C:","LlorR","data","raw","LoR_DECK.csv"),na.strings = c("",NA))
```

# Data {.unnumbered}

```{r account-info}
masterEU   <- LoR.Account.RMD %>% filter(activeShard=="europe"   & master=="master") %>% distinct(gameName,tagLine) %>% count() %>% pull()
masterNA   <- LoR.Account.RMD %>% filter(activeShard=="americas" & master=="master") %>% distinct(gameName,tagLine) %>% count() %>% pull()
masterASIA <- LoR.Account.RMD %>% filter(activeShard=="asia"     & master=="master") %>% distinct(gameName,tagLine) %>% count() %>% pull()

namesList.EU.RMD   <- lor_leaderboard("europe")$name
namesList.NA.RMD   <- lor_leaderboard("americas")$name
namesList.ASIA.RMD <- lor_leaderboard("asia")$name
```

```{r nGames-data}
minrow_live <- min(which(LoR.Match.RMD[,game_start_time_utc >= as.POSIXct(params$start)]))
maxrow_live <- max(which(LoR.Match.RMD[,game_start_time_utc  < as.POSIXct(params$end)]  ))

max_time <- LoR.Match.RMD %>%
  filter( game_start_time_utc >= as.POSIXct(params$start, tz = "UTC") & game_start_time_utc < as.POSIXct(params$end, tz = "UTC") & game_type=="Ranked") %>%
  slice_max(game_start_time_utc) %>% 
  pull(game_start_time_utc) %>%
  format(.,format = "%Y-%m-%d %H:%M:%S")

nGames <- LoR.Match.RMD %>% 
  filter( game_start_time_utc >= as.POSIXct(params$start, tz = "UTC") & game_start_time_utc < as.POSIXct(params$end, tz = "UTC") & game_type=="Ranked") %>%
  tabyl(game_type) %>%
  filter( game_type=="Ranked" ) %>%
  pull(n)
```

`r kableExtra::text_spec("Note:", color = "red")` As the current sample size is terrible to estimate WR of MU, the MU section is not present in this report. The data is being updated in the MU dedicated page but there the data will continue to be updated being an a better picture overall.

Number of (Ranked) matches analyzed **`r nGames %>% format(.,scientific = F)`** or **`r (nGames*2) %>% format(.,scientific = F)`** games.

Last Update: `r format(Sys.time(),format = "%Y-%m-%d %H:%M")` [^1]

[^1]: Reminding that while I may collect the 'list of all games-id' played in a certain timeframe I can only collect all their metadata several hours later. So after the first release the numbers may be updated later during the week, be it for the sake of updating or modifying some code.

```{r table-nGames-data, layout="l-body"}
nGames_tbl <- LoR.Match.RMD %>%
  #' Stay only 'among' the row with the games in the time-frame I want
  ####################################################################
  slice(minrow_live:maxrow_live) %>%
  #' Extrapolate Friendly and 'to Scrap' matches
  ##############################################
  mutate( game_type = case_when(
    status==404   ~ "Friendly",
    is.na(status) ~ "to Scrap",
    TRUE ~ as.character(game_type)
    )) %>%
  #' Give to the new game_types a game_start_time_utc among the timeframe on interest
  #' so it can be used a filter without worrying about other parameter like status and so on
  ##########################################################################################
  mutate( game_start_time_utc = replace( game_start_time_utc, game_type %in% c("Friendly","to Scrap"),  as.POSIXct(params$start, tz = "UTC")+days(3) ) ) %>%
  filter( game_start_time_utc >= as.POSIXct(params$start, tz = "UTC") & game_start_time_utc < as.POSIXct(params$end, tz = "UTC") ) %>%
  mutate( game_type = fct_other(factor(game_type),keep = c("Ranked","Friendly","to Scrap")) %>% fct_infreq() ) %>%
  select(Status=game_type,Server=server) %>%
  #' Create tbl
  #############
  tbl_summary() %>%
  modify_footnote(
    update = stat_0 ~
      md(glue::glue("Metadata from Friendly Matches (that aren't Bo3) is not recoverable, \n the value may not be perfect since I lack the starting time of the game. The amount of Games to still scrap is also an estimation based on the 'position' of the game" ))
  ) %>%
  # modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  as_gt() %>%
  tab_header(
    title = "by the Numbers",
    subtitle = "Patch 2.13 first week / Master players"
    # subtitle = glue::glue("Data for games in {params$start}")
  ) %>%
  tab_footnote(
    footnote = md(glue::glue("Max datetime recovered: {max_time} UTC from {params$start} to {params$end} UTC" )),
    locations = cells_title(groups = c("subtitle"))
    ) %>%
  tab_footnote(
    footnote = md(glue::glue("EU Master players in the ladder: {length(namesList.EU.RMD)} while number of possible Master players recovered is: {masterEU} \n
                              NA Master players in the ladder: {length(namesList.NA.RMD)} while number of possible Master players recovered is: {masterNA} \n
                              ASIA Master players in the ladder: {length(namesList.ASIA.RMD)} while number of possible Master players recovered is: {masterASIA}" )),
    locations = cells_title(groups = c("subtitle"))
  ) %>%
  tab_options(data_row.padding = px(1.2))
  
nGames_tbl %>%
 tab_options(
    table.background.color = "transparent",
    table.font.color = "black",
    table.font.color.light = "black"
   )

# gtsave(nGames_tbl,"images/rep_data.png")
```

```{r prepare-data}
LoR.Melt.Matches.RMD <- LoR.Match.RMD %>%
  #' Base filters
  filter( game_type=="Ranked" ) %>%
  filter( game_start_time_utc >= as.POSIXct(params$start, tz = "UTC") & game_start_time_utc < as.POSIXct(params$end, tz = "UTC") ) %>%
  #' 'process' data
  left_join(.,LoR.Deck[,.(deck_code,archetype)] %>% setnames(old = "archetype", new = "player_1")   ,by=c("deck_code_1"="deck_code")) %>%
  left_join(.,LoR.Deck[,.(deck_code,archetype)] %>% setnames(old = "archetype", new = "opponent_1") ,by=c("deck_code_2"="deck_code")) %>%
  mutate( player_2 = opponent_1, opponent_2 = player_1, oppoppuid_1 = puuid_2, oppoppuid_2 = puuid_1 ) %>%
  select( match_key,server,game_start_time_utc,game_version,total_turn_count,
          ends_with("_1"),ends_with("_2"),-ends_with("_3"),-ends_with("_4"),-contains("deck_id"),-contains("participants") ) %>%
  #' melt data
  melt(id.vars=c("match_key","server","game_start_time_utc","game_version","total_turn_count"), measure.vars=patterns(
    str_sub(
      names(select(.,ends_with("_1")))
      ,end = -3)
  ),
  value.name = str_sub(
    names(select(.,ends_with("_1")))
    ,end = -3)
  ) %>%
  #' finish 'process' data
  left_join(. , LoR.Account.RMD[,c("puuid","RiotID","refID")] %>% setnames(old = "RiotID", new = "userID")     ,by=c("puuid"="puuid")) %>%
  left_join(. , LoR.Account.RMD[,c("puuid","RiotID")] %>% setnames(old = "RiotID", new = "opponentID") ,by=c("oppoppuid"="puuid")) %>%
  left_join(.,LoR.Deck %>% select(!archetype),by=c("deck_code","factions")) %>%
  select(-ends_with("puuid"),-refID)
```

```{r}
# LoR.Melt.Matches.RMD %>%
#   filter(if_any(contains("Card"), ~str_starts(., "05") ))
```


# Regions

## Play Rate
::: l-body-outset

```{r}
iconRegion <- regionIcons
colorRegion.Balco <- list.levels$colorRegion.Balco
```


```{r process-tableFreq}
Region.Freq <- LoR.Melt.Matches.RMD %>%
  select(factions) %>%
  separate_rows(factions,sep=",") %>%
  tabyl(factions,show_na=F) %>%
  tibble() %>% 
  rename_all(~c("region","n","freq")) %>%
  mutate(region = fct_recode(region,!!!recodeRegLevels)) %>% 
  add_column(., icon = iconRegion)

Region.Freq.Server <- LoR.Melt.Matches.RMD %>%
  select(server,factions) %>%
  separate_rows(factions,sep=",") %>%
  tabyl(factions,server, show_na = F) %>%
  adorn_percentages("col") %>%
  mutate(region = fct_recode(factions,!!!recodeRegLevels),.keep = "unused")

Region.Freq <- full_join(Region.Freq,Region.Freq.Server,by="region")
```

::::: {.panelset}
::: {.panel}

### Plot {.panel-name}

```{r plot-Region}
sxLabel_card <- format(Region.Freq$freq*100,2)
dxLabel_card <- format(Region.Freq$freq*100,2)
sxLabel_card <- ifelse(as.numeric(sxLabel_card) > 4,  sxLabel_card , "") %>% as.numeric() %>% scales::number(., accuracy = 0.01)
dxLabel_card <- ifelse(as.numeric(dxLabel_card) <= 4, dxLabel_card , "") %>% as.numeric() %>% scales::number(., accuracy = 0.01)

RegionByRegion <- Region.Freq %>%
  ggplot(aes(x = reorder(region, freq), y = freq)) +
  geom_bar(stat="identity") +
  geom_bar_pattern(
    aes(
      pattern_filename = region,
    ),
    stat            = 'identity',
    pattern         = 'image',
    pattern_type    = 'none',
    fill            = colorRegion.Balco,
    colour          = 'black',
    pattern_scale   = -2,
    pattern_filter  = 'point',
    pattern_gravity = 'east'
  ) +
  theme_bw() +
  theme(legend.position = 'none') +
  labs(
    title = "Regions Play Rate",
    subtitle = "number of times a region is included in a deck",
    x = "Region",
    y = "Play Rate"
    # caption = "number of times a region is included in a deck" 
  ) +
  theme( plot.title    = element_text(face = "bold", size = 15),
         plot.subtitle = element_text(size = 12),
         axis.title.x  = element_text(face = "bold", size = 12),
         axis.title.y  = element_text(face = "bold", size = 12),
         axis.text.x   = element_text(size = 8)
         ) +
  annotate(geom = 'text', 
         x = 1.0, 
         y = 0.15, 
         hjust = 0.5,
         label = glue::glue('n = {nGames}\nGini Index = {round(DescTools::Gini(Region.Freq$freq,na.rm = T),3)}'), 
         fontface = 'bold') +
  coord_flip() +
  scale_pattern_filename_discrete(choices = iconRegion ) +
  scale_pattern_discrete(guide = guide_legend(nrow = 1)) +
  scale_fill_manual("legend", values = colorRegion.Balco) +
  scale_y_continuous(limits = c(0, round(max(Region.Freq$freq+0.04 ),3) ),
                     breaks = seq(0,0.5,0.04),
                     expand = c(-0.001,0.02),
                     labels = scales::percent_format(accuracy = 1) ) +
  guides(fill = "none") +
  #' Adding the text of the frequencies
  geom_text(aes(label = sxLabel_card), hjust = 2.2, size = 5,position = position_dodge(width = 1)) +
  geom_text(aes(label = dxLabel_card), hjust = -0.5, size = 5,position = position_dodge(width = 1))
  
RegionByRegion
```

The Gini Index is a measure of heterogeneity so, in this case and in simpler terms, how much the play rates are similar. The Index goes (when normalized like here) $in$ [0,1] and it's equal to 1 when there's a single value with 100% play rate or 0 when all play rates are equal. Of course a Gini Index of 1 needs to be avoided but it's not like the aim should be 0. As said, it's just to add some additional tools.

:::

::: {.panel}
### Table {.panel-name}

```{r print-tableFreq-gt}
Region.Freq.tbl <- Region.Freq %>%
  select(-n,-icon) %>%
  arrange(desc(freq)) %>%
  gt( ) %>%
  tab_header(
    title = "Region Play Rate",
    subtitle = "Relative Frequencies by Inclusion Rate of a Region"
  ) %>%
  tab_spanner(
    label = "Shard",
    columns = c(americas, asia, europe)
  ) %>%
  fmt_percent(
    columns = c(2:5),
    decimals = 2
  ) %>%
  cols_align(
    align = "left",
    columns = 1
  ) %>%
  cols_align(
    align = "center",
    columns = c(2:5)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = 1,
    )
  ) %>%
  cols_label(
    region   = md("**Region**"),
    freq     = md("**Freq**"),
    americas = md("**America**"),
    asia     = md("**Asia**"),
    europe   = md("**Europe**")
  ) %>%
   tab_options(
    table.background.color = "transparent",
    table.font.color = "black",
    table.font.color.light = "black"
   )

Region.Freq.tbl

# Region.Freq.tbl <- gtsave(
#     "images/reg_freq.png",
# )
```
:::
:::::
<!-- Close Region 1 panelset -->
:::

## Play Rate by number of Cards
::: l-body-outset

```{r process-tableFreq_byCard}
Card.Subset <- LoR.Melt.Matches.RMD %>%
  select( starts_with( "Card" ) )

Regions.Freq.byCards <- LoR.Melt.Matches.RMD %>%
  select( starts_with( "Card") ) %>% 
  map_df(.,~str_sub(.x, start=3,end=4) ) %>%
  mutate_all(~fct_recode(.,!!!recodeRegShort)) %>%
  unlist(use.names = FALSE) %>% 
  tabyl(., show_na = F) %>% 
  rename_all(~c("region","n","freq")) %>% 
  mutate(.,region := as.character(region))
  
setorderv(Regions.Freq.byCards, c("region"), c(1))

# Regions.Freq.byCards <- as.tibble(Regions.Freq.byCards)
Regions.Freq.byCards$freq <- round(Regions.Freq.byCards$freq,4)
Regions.Freq.byCards$icon <- iconRegion

Regions.Freq.byCards.Server <- LoR.Melt.Matches.RMD %>%
  select( starts_with( "Card") ) %>% 
  map_df(.,~str_sub(.x, start=3,end=4) ) %>%
  mutate_all(~fct_recode(.,!!!recodeRegShort)) %>%
  add_column(server = LoR.Melt.Matches.RMD$server ) %>%
  melt(id.var=c("server")) %>%
  select(value,server) %>%
  tabyl(value,server, show_na = F) %>%
  adorn_percentages("col") %>%
  select(c(2,3,4))  

Card.tableByRegPlot <- LoR.Melt.Matches.RMD %>%
  select( starts_with( "Card") ) %>% 
  map_df(.,~str_sub(.x, start=3,end=4) ) %>%
  mutate_all(~fct_recode(.,!!!recodeRegShort)) %>%
  add_column(server = LoR.Melt.Matches.RMD$server ) %>%
  melt(id.var=c("server")) %>%
  select(value,server) %>% table() %>% prop.table(.,margin = 2) %>% as.data.table()
```

::::: {.panelset}
::: {.panel}
### Plot {.panel-name}

```{r plotRegion_byCards}
sxLabel_card <- format(Regions.Freq.byCards$freq*100,2)
dxLabel_card <- format(Regions.Freq.byCards$freq*100,2)
sxLabel_card <- ifelse(as.numeric(sxLabel_card) > 4,  sxLabel_card , "") %>% as.numeric() %>% scales::number(., accuracy = 0.01)
dxLabel_card <- ifelse(as.numeric(dxLabel_card) <= 4, dxLabel_card , "") %>% as.numeric() %>% scales::number(., accuracy = 0.01)

RegionByCards <- Regions.Freq.byCards %>%
  ggplot(aes(x = reorder(region, freq), y = freq)) +
  geom_bar_pattern(
    aes(
      pattern_filename = region,
    ),
    stat            = 'identity',
    pattern         = 'image',
    pattern_type    = 'none',
    fill            = colorRegion.Balco,
    colour          = 'black',
    pattern_scale   = -2,
    pattern_filter  = 'point',
    pattern_gravity = 'east'
  ) +
  theme_bw() +
  theme(legend.position = 'none') +
  labs(
    title = "Regions Play Rate",
    subtitle = "number of times a card within a region is included in a deck",
    x = "Region",
    y = "Play Rate"
    # caption = "number of times a region is included in a deck
  ) +
  theme( plot.title    = element_text(face = "bold", size = 15),
         plot.subtitle = element_text(size = 12),
         axis.title.x  = element_text(face = "bold", size = 12),
         axis.title.y  = element_text(face = "bold", size = 12),
         axis.text.x   = element_text(size = 8)
         ) +
  annotate(geom = 'text', 
         x = 1.0, 
         y = 0.15, 
         hjust = 0.5,
         label = glue::glue('n = {nGames}\nGini Index = {round(DescTools::Gini(Regions.Freq.byCards$freq,na.rm = T),3)}'), 
         fontface = 'bold') +
  coord_flip() +

  scale_pattern_filename_discrete(choices = iconRegion) +
  scale_pattern_discrete(guide = guide_legend(nrow = 1)) +
  scale_fill_manual("legend", values = list.levels$colorRegion.Balco) +
  # nome of the table
  scale_y_continuous(limits = c(0, round(max(Regions.Freq.byCards$freq+0.04 ),3) ),
                     breaks = seq(0,0.5,0.04),
                     expand = c(-0.001,0.02),
                     labels = scales::percent_format(accuracy = 1) ) +
  # geom_text(aes(label=format(freq*100,2)),
  #           hjust = 2, size = 5,position = position_dodge(width = 1)) +
  geom_text(aes(label=sxLabel_card),
            hjust = 2.2, size = 5,position = position_dodge(width = 1)) +
  geom_text(aes(label=dxLabel_card),
            hjust = -0.5, size = 5,position = position_dodge(width = 1)) +
  guides(fill = "none")

RegionByCards
```
:::

::: {.panel}
### Table {.panel-name}

```{r print-tableFreq_byCard-gt}
Region.Freq.byCards.tbl <- Regions.Freq.byCards[,c("region","freq")] %>%
  cbind(.,Regions.Freq.byCards.Server) %>%
  arrange(desc(freq)) %>%
  gt( ) %>%
  tab_header(
    title = "Region Play Rate",
    subtitle = "Relative Frequencies by number of times a Card within a Region is included in a Deck"
  ) %>%
  tab_spanner(
    label = "Shard",
    columns = c(americas, asia, europe)
  ) %>%
  fmt_percent(
    columns = c(2:5),
    decimals = 2
  ) %>%
  cols_align(
    align = "left",
    columns = 1
  ) %>%
  cols_align(
    align = "center",
    columns = c(2:5)
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = 1,
    )
  ) %>%
  cols_label(
    region   = md("**Region**"),
    freq     = md("**Freq**"),
    americas = md("**America**"),
    asia     = md("**Asia**"),
    europe   = md("**Europe**")
  ) %>%
   tab_options(
    table.background.color = "transparent",
    table.font.color = "black",
    table.font.color.light = "black"
   )

Region.Freq.byCards.tbl

# Region.Freq.tbl <- gtsave(
#     "images/reg_freq.png",
# )
```
:::
:::::
<!-- Close Region 2 panelset -->
:::

# Champions Combinations

```{r process-tableChampion}
CC.tableByReg <- LoR.Melt.Matches.RMD %>%
  tabyl(player,server) %>%
  adorn_percentages("col")

CC.table <- LoR.Melt.Matches.RMD %>%
  tabyl(player, show_na = F) %>%
  rename_all(~c("player","n","freq")) %>%
  left_join(.,CC.tableByReg,by="player")
```

## Play Rates

::: l-body-outset

::::: {.panelset}
::: {.panel}
### Plot {.panel-name}

```{r plot-Champion-PR}
nrowPlot <- 20

ChampionCombo.plot <- CC.table %>%
  arrange(desc(freq)) %>%
  slice_head(.,n = 20) %>%
  ggplot(aes(x = reorder(player, freq), y = freq))  +

  geom_bar( stat = "identity",fill="steelblue" ) +
  coord_flip() +
  guides(fill = "none")  +
  theme_bw() +
  geom_text(aes(label=round(freq*100,2)),
            # face = "bold",
            hjust = -0.5, size = 4,
            # vjust=-0.25
            # position = position_dodge(width = 1)
            position = position_dodge(0.9)
            ) +
  # scale_fill_manual("legend", values = list.levels$colorRegion.Balco) +
  scale_y_continuous(limits = c(0, round(max(CC.table$freq+0.04 ),3) ),
                     breaks = seq(0,0.20,0.02),
                     expand = c(-0.001,0.02),
                     labels = scales::percent_format(accuracy = 1) ) +

  theme( plot.title = element_text(face = "bold", size = 12, hjust = 0.6),
         axis.title.x = element_text(face = "bold"),
         axis.title.y = element_text(face = "bold"),
         legend.position = "none") +

  labs(x = "Champions", y = "Play Rate",
       caption = paste0("Relative frequencies of the top ",nrowPlot," combination of champions in a deck")
       ) +
  annotate(geom="text", x=3, y=0.08, col="black",label = paste("n =",nGames,"\n"," cumulative frequence \n ",
                                                               paste0(CC.table %>% arrange(desc(freq)) %>% slice_head(.,n = 20) %>% select(freq) %>% sum() %>% round(.,4)*100 ,"%") )
           )

ChampionCombo.plot

# mtcars %>%
#   group_by(cyl) %>%
#   summarize(wt = mean(wt), mpg = mean(mpg)) %>%
#   ungroup() %>%
#   mutate(wt = sprintf("%.2f", wt),
#          mpg = sprintf("%.1f", mpg)) -> tb

```
:::

::: {.panel}
### Table {.panel-name}

```{r table-Champion-PR}
CC.table %>%
  arrange(desc(freq)) %>%
  # filter(nGames>100) %>%
  select(player,freq,americas,asia,europe) %>%
  reactable(.,
            bordered = TRUE,
            highlight = TRUE,
            striped = TRUE,
            searchable = TRUE,
            compact = TRUE, # compact the table height
            fullWidth = TRUE, # don't fill the page
            defaultPageSize = 20,
            wrap = TRUE,
            # filterable = TRUE,
            defaultColDef = colDef(
              style = list(fontFamily = "Roboto", fontSize = "13px"), align = "center"
              # minWidth = 120,
            ),
            columns = list(
              player = colDef(name = "Champions",minWidth = 120, style = list(fontSize = "11px", fontWeight = "bold", color="black") ),
              
              freq     = colDef(name = "Play Rate",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ),
              americas = colDef(name = "America",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ),
              asia     = colDef(name = "Asia",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ),
              europe   = colDef(name = "Europe",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") )
              )
    )

```
:::
:::::
<!-- Close CC lay Rate panelset -->
:::

## Day by Day

Highlisting the top10 most played decks (at the moment of the last game played).

```{r champion-freq-by-date}
m = 10

Champion.deck.daily <- (LoR.Melt.Matches.RMD %>%
  rename(.,"champions"="player") %>%
  arrange(game_start_time_utc) %>%
  select(game_start_time_utc,champions) %>%
  mutate( num_cc = factor(champions) %>% as.numeric() ))[ , cumFreq := (cumsum(num_cc)/num_cc)/.I , by=champions ] %>%
  select(!num_cc) %>%
  mutate( champions = factor(champions) %>% fct_infreq() )

fct_values <- LoR.Melt.Matches.RMD %>%
  # mutate( top5 = fct_lump(champions, n = m, w = tot, ties.method = "max") ) %>%
 mutate( top5 = fct_lump_n(player,n = m) %>% fct_infreq() ) %>%
 pull(top5) %>% levels()
```

```{r plot-date-by-date}
meta_evo <- ggplot(
   # The ggplot object has associated the data for the highlighted countries
  data = Champion.deck.daily %>% filter(champions %in% fct_values[-1]),
  aes(game_start_time_utc, cumFreq, group = champions)
  ) +
  ## Lines for the non-highlighted countries
  geom_line(
    data = Champion.deck.daily %>% filter(champions %!in% fct_values[-1]),
    color = "grey75",
    size = .6,
    alpha = .5
  ) +
  ## Lines for the highlighted countries.
  # It's important to put them after the grey lines
  # so the colored ones are on top
  geom_line(
    aes(color = champions),
    size = .9
  ) +
  # geom_text(aes(label=champions,color = champions))
  geom_text_repel(
    data = Champion.deck.daily %>% filter(champions %in% fct_values[-1]) %>% group_by(champions) %>% slice_max(game_start_time_utc,n=1) %>% distinct(game_start_time_utc,champions,.keep_all = T),
    aes(label=str_to_upper(champions),color = champions),
    # aes(color = champions, label = champions),
    family = "Lato",
    fontface = "bold",
    size = 3,
    direction = "y",
    xlim = c(as.POSIXct(max(Champion.deck.daily$game_start_time_utc) + hours(12)), NA),
    force = 3,
    hjust = 1,
    segment.size = .7,
    segment.alpha = .5,
    segment.linetype = "dotted",
    box.padding = .4,
    segment.curvature = -0.1,
    segment.ncp = 3,
    segment.angle = 15
  ) +
  scale_x_datetime(
    # expand = c(0.02,0.01),
    date_minor_breaks = "1 day",
    limits = c(as.POSIXct(params$start, tz="UTC"), as.POSIXct(params$end, tz="UTC")+hours(24))
    # limits = c(as.POSIXct(params$start, tz="UTC"), as.POSIXct(params$end, tz="UTC"))
  )  +
  scale_y_continuous(
    expand = c(0, 0),
    limits = c(0,0.25),
    breaks = seq(0,0.25,0.02),
    labels = scales::percent_format(accuracy = 1) # glue::glue("{format(seq(0, 0.20, by = 0.05), nsmall = 2)}%")
  ) +
  scale_color_manual(
    values = c(rcartocolor::carto_pal(n = 10, name = "Vivid")[1:10-1], "grey50")
  ) +
  labs(x = "Date",
       y = "Percent",
       title = "Evolution of Play Rate over time"
       # caption = glue::glue("Data from Riot API • Ranked games from Master players • ... ")
  ) +
  # tab_footnote(
  #   footnote = md(glue::glue("Max datetime recovered: {max_time} UTC from {params$start} to {params$end} UTC" )),
  #      ) + 
  theme_bw() +
  theme(
    plot.title    = element_text(face = "bold", size = 15),
    axis.title.x  = element_text(face = "bold", size = 12),
    axis.title.y  = element_text(face = "bold", size = 12),
    axis.text.x   = element_text(size = 8),
    legend.position = "none"
  )

meta_evo
```

## Win Rates

Tie games are excluded

```{r get-muWR}
MUtbl <- LoR.Melt.Matches.RMD %>%
  
  filter(game_outcome!="tie") %>%
  select( player,opponent,game_outcome,server ) %>%
  group_by(player,opponent) %>%
  summarise( muWin   = sum(game_outcome=="win"),
             muGames = n(),
             muWR=mean(game_outcome=="win") ) %>%
  setDT()

MUtbl[, c("LCI","UCI") := binom.confint(muWin,muGames,0.95,methods="exact")[5:6] ]
MUtbl[, okCI:=(!between(0.50,LCI,UCI)) ]
MUtbl[, direction:=ifelse(muWR>0.50,"POS","NEG")  ]

MUtbl <- MUtbl %>%
  mutate( CI := glue("({percent(LCI,accuracy = 0.1)} - {percent(UCI,accuracy = 0.1)})" ) )
```

```{r process-winRate}
WR.DT <- LoR.Melt.Matches.RMD %>%
  filter(game_outcome!="tie") %>%
  select( player,opponent,game_outcome ) %>%
  group_by(player) %>%
  summarise( nWin   = sum(game_outcome=="win"),
             nGames = n(),
             WR=mean(game_outcome=="win")
            ) %>%
  ungroup() %>%
  mutate( playrate = nGames/sum(nGames) )

options(scipen = 999)

WR.DT.Reg <- LoR.Melt.Matches.RMD %>%
  filter(game_outcome!="tie") %>%
  select( player,opponent,game_outcome,server ) %>%
  group_by(server,player) %>%
  summarise( nWin   = sum(game_outcome=="win"),
             nGames = n(),
             WR=mean(game_outcome=="win"),
            ) %>%
  ungroup() %>%
  group_by(server) %>%
  mutate( sumGames = sum(nGames), regPlayrate = nGames/sumGames ) %>%
  left_join(.,WR.DT[,c("player","playrate")],by="player") 

# WR.DT.Reg %>%
#   group_by(player) %>%
#   summarise( WIN = sum(nWin), GAMES = sum(nGames)  ) %>%
#   filter( player %in% c("Viego (FR/SI)","Jarvan IV / Shen") )
# 
# WR.DT %>%
#   filter( player %in% c("Viego (FR/SI)","Jarvan IV / Shen") )
```
::: l-body-outset

::::: {.panelset}
::: {.panel}
### Meta Decks {.panel-name}

Win rates of the most played combination of champions. Play Rate \>= 1% in at least one of the servers.

```{r print-tableWinRate}
WR.DT.Reg %>%
  arrange(desc(playrate)) %>%
  filter(playrate >= 0.01) %>%
  # slice_max(player,n = 10, with_ties = T) %>%
  arrange(desc(playrate)) %>%
  relocate(player,WR,nWin,nGames,regPlayrate,server) %>%
  reactable(., groupBy = "player",
            # searchable = TRUE,
            bordered = TRUE,
            # wrap = FALSE,
            highlight = TRUE,
            striped = TRUE,
            # filterable = TRUE,
            defaultColDef = colDef(
              # header = function(value) str_to_title(value),
              #  cell = function(value) format(value, nsmall = 1),
              align = "center",
              minWidth = 70
              # headerStyle = list(background = "steelblue",color="white")
            ),
            columns = list(
              player = colDef(name = "Champions",minWidth = 150),
              server = colDef(name = "Server", aggregate = "unique"),
              nWin   = colDef(name = "#Win", aggregate = "sum"),
              nGames = colDef(name = "#Games", aggregate = "sum"),
              WR     = colDef(name = "WinRate", aggregate = JS(
                "function(values, rows) {
                    var totalWin = 0
                    var totalGames = 0
                    rows.forEach(function(row) {
                    totalWin   += row['nWin']
                    totalGames += row['nGames']
                    })
                  return totalWin / totalGames
                    }"
                ),format = colFormat(percent = TRUE,digits = 1),
              ),
              regPlayrate   = colDef(name = "Play Rate",
                aggregate = JS("function(values, rows) {
                var total = 0;
                var n = 0;
                rows.forEach(function(row) {
                  total += row['playrate']
                  n += 1
                })
                return total/n
                }"),
                format = colFormat(percent = TRUE,digits = 1)),
              sumGames   = colDef(show=F),
              playrate   = colDef(show=F)
  )
)
```
:::

::: {.panel}
### Underdog {.panel-name}

Top Win rates of the top10 best performing least played combination of champions. Play rate $\in$ [0.1%,1%)[^2]

[^2]: Min number of games 50, during the times a meta/ladder just changed.

```{r print-under-tableWinRate}
WR.DT %>%
  filter( nGames >= 50 & WR >= 0.50 & playrate >= 0.001 & playrate < 0.01) %>%
  slice_max(WR,n = 10) %>%
  relocate(player,WR,nWin,nGames,playrate) %>%
  arrange(desc(WR)) %>%
  reactable(.,
            # searchable = TRUE,
            bordered = TRUE,
            # wrap = FALSE,
            highlight = TRUE,
            striped = TRUE,
            # filterable = TRUE,
            defaultColDef = colDef(
              # header = function(value) str_to_title(value),
              #  cell = function(value) format(value, nsmall = 1),
              align = "center",
              minWidth = 70,
              headerStyle = list(background = "steelblue",color="white")
            ),
            columns = list(
              player = colDef(name = "Champions",minWidth = 150),
              nWin   = colDef(name = "#Win"),
              nGames = colDef(name = "#Games"),
              WR     = colDef(name = "WinRate",format = colFormat(percent = TRUE,digits = 1) ),
              playrate   = colDef(name = "Play Rate",format = colFormat(percent = TRUE,digits = 1))
  )
)
```
Looking at this week results it's clear most of these decks can be grouped as 'Plunder' decks. I'm working on it, but I'm still far from reaching a quality of the results that satisfy me.

:::
:::::
<!-- Close Win Rate panelset -->
:::

# Deck Structure of the week {.tabset .tabset-fade .tabset-pills}

```{r deck-structure-prepare}
# brks <- c(0.50,0.55,0.60,0.65,0.70,0.75,0.80,0.85,0.90,0.95)
# clrs = colorRampPalette( c("white","steelblue") )(length(brks)+1)

deck_color_generator <- scales::col_numeric(c("white", "white","green"), domain = NULL)

make_color_pal <- function(colors, bias = 1) {
  get_color <- colorRamp(colors, bias = bias)
  function(x) rgb(get_color(x), maxColorValue = 255)
}

good_color <- make_color_pal(c("white", "white", "#9bc2e6"))
```

::::: {.panelset}
::: {.panel}
## Draven / Sion / ver.PnZ

```{r}
SubDeck_deck_code <- LoR.Melt.Matches.RMD %>%
  filter( player == "Draven / Sion (NX/PZ)" ) %>%
  pull(deck_code)

data <- get_deck_structure(SubDeck_deck_code)

data %>%
  reactable(.,
            bordered = TRUE,
            highlight = TRUE,
            searchable = TRUE,
            compact = TRUE, # compact the table height
            fullWidth = T, # don't fill the page
            defaultPageSize = 20,
            wrap = TRUE,
            # filterable = TRUE,
            defaultColDef = colDef(
              style = function(value) {
                if (!is.numeric(value)) return()
                # normalized <- (value - min(nottem)) / (max(nottem) - min(nottem))
                # good_color(0.8)
                color <- good_color(value)
                list(background = color,fontFamily = "Roboto", fontSize = "14px")
                },
              # format = colFormat(digits = 1),
              # fontSize = "15px",
              headerStyle = list(background = "whitesmoke",color="black", align = "center"),
              
              align = "center",
              minWidth = 120
              ) ,
            columns = list(
              name     = colDef(name = "Card",minWidth = 120, style = list( fontWeight = "bold", fontFamily = "Roboto", fontSize = "13px" ), align = "left" ),
              playrate = colDef(name = "PlayRate", format = colFormat(percent = TRUE,digits = 1) ),
              `3`      = colDef(name = "3",format = colFormat(percent = TRUE,digits = 1) ),
              `2`      = colDef(name = "2",format = colFormat(percent = TRUE,digits = 1) ),
              `1`      = colDef(name = "1",format = colFormat(percent = TRUE,digits = 1) )
              ),
            columnGroups = list(
              colGroup(name = glue::glue("Draven Sion (PZ)"), columns = c("name"), headerStyle = list(background = "whitesmoke",color="black", align = "center") ),
              colGroup(name = glue::glue("Playrate (N: {length(SubDeck_deck_code)})"), columns = c("playrate","3","2","1"),headerStyle = list(background = "whitesmoke",color="black", align = "center"))
              )
            )
```
:::

> How to read the table: <br> - Play rate: How often a card is included in this class of decks / the table is order by this column. <br> - 3/2/1 is the relative and absolute frequency of the number of copies in the decks that plays them <br> - Frequencies from 50% to 100% are colored from shades of green to white to identify more easily the highest values

:::::
<!-- Close Deck Structure panelset -->

# LoR-Meta Index (LMI)

> The LMI [^3] is an Index I developed to measure the performance of decks in the metagame. For those who are familiar with basic statistical concept I wrote a document to explain the theory behind it: , it's very similar to [vicioussyndicate](https://www.vicioussyndicate.com) (vS) Meta Score from their data reaper report. The score of each deck ***is not*** just their "strength", it takes in consideration both play rates and win rates that's why I prefer to say it measure the "performance". The values range from 0 to 100 and the higher the value, the higher is the performance.

[^3]: [LMI - Early Theory](https://llorr-stats.netlify.app/analysis/lmi/)

```{r data-aggregation}
DT.Aggreation <- WR.DT %>%
  filter( nGames > 100 ) %>%
  # filter( playrate > 0.01 ) %>%
  mutate( freq_ind    = scale_quantile(playrate) ) %>%
  mutate( wr_ind      = scale_quantile(WR) ) %>%
  rowwise() %>%
  mutate( hmeta_ind = harm.mean(c_across(ends_with("ind")) ) )
```

```{r ggplotly-LMI,echo=FALSE}
textWRPR <- function(Deck,WR, playrate){
  glue("Deck: {Deck}\nWin Rate: {scales::percent(WR,accuracy = 0.1)}\nPlay Rate: {scales::percent(playrate,accuracy = 0.1)}")
}

f <- list(
  family = "Courier New, monospace",
  size = 18,
  color = "#7f7f7f"
)

fig <- DT.Aggreation %>%
  select(player,WR,playrate,wr_ind,freq_ind,hmeta_ind) %>%
  mutate_if(is.numeric, funs(round(., 4)) ) %>%
  mutate( tooltip = textWRPR(player,WR,playrate) ) %>%
  rename("Deck"="player","Win_Rate"="WR","Play_Rate"="playrate","WR Index"="wr_ind","Freq Index"="freq_ind","LMI"="hmeta_ind") %>%
  plot_ly(
    type = 'scatter',
    mode = 'markers',
    x = ~`WR Index`,
    y = ~`Freq Index`,
    marker = list(size = ~LMI*100, sizeref = 0.1, sizemode = 'area'),
    color = ~LMI,
    text = ~tooltip,
    hovertemplate = paste(
      "LMI:<b>%{marker.size:,}<br>",
      "<b>%{text}</b><br><extra></extra>",sep = ""
      # "%{yaxis.title.text}: %{y:$,.0f}<br>",
      # "%{xaxis.title.text}: %{x:.0%}<br>",
      # "Number Employed: %{marker.size:,}",
      # "<extra></extra>"
      )
    ) %>% layout(xaxis = list(title = "WR Index",titlefont = f),
                 yaxis = list(title = "Freq Index",titlefont = f),
                 title = 'LoR-Meta Index (LMI)'
                 ) %>% suppressWarnings()

fig
```


# Cards Presence

```{r process-UniqueCards}
allCards            <- unlist(apply(Card.Subset, 1, unique),use.names = F)
TableAllCards       <- table(allCards)
RegionShortAllCards <- str_sub(names(TableAllCards),3,4)
TableCardsDT        <- data.table(TableAllCards)
setnames(TableCardsDT,old = "allCards",new = "card")

TableCardsDT[ ,region    := str_sub(card,3,4) ]
TableCardsDT[ ,regionID  := fct_recode(region,!!!recodeRegPosition) ]
TableCardsDT[ ,nGamesReg := Region.Freq$n[as.numeric(as.character(regionID))] ]
# Region.Freq contain the frequencies of appearence of each region in the decks
TableCardsDT[ ,p.byReg   := round(N/nGamesReg,3) ]
# Frequence of a card appearing in a deck within its own region

TableCardsDT[ ,card    :=fct_recode(card,   !!!recodeCardsCode)]
TableCardsDT[ ,region  :=fct_recode(region, !!!recodeRegShort)]
```
::::: {.panelset}
::: {.panel}
## Play Rate {.panel-name}

It seems that not even Twin Disciple can beat Sharsight

```{r print-CardsTable-1}
MostPlayed <- TableCardsDT %>%
  arrange(desc(p.byReg)) %>%
  setNames(., c("Card","# Decks with that card ","Region","RegionID","Games of X Region","Play Rate")) %>%
  select(c(1,3,6,2)) %>%
  datatable(., rownames = FALSE) %>%
  formatStyle('Card', fontWeight = 'bold') %>%
  formatStyle('Play Rate', fontWeight = 'bold') %>%
  formatStyle('Play Rate', fontWeight = 'bold') %>% formatStyle(
    'Region',
    target = 'row',
    backgroundColor = styleEqual(list.levels$factions.clean, list.levels$colorRegion.Balco)
  ) %>%
  formatPercentage('Play Rate', 1)
  # formatStyle('Card',  color = 'red', backgroundColor = 'orange', fontWeight = 'bold')

MostPlayed
```
:::

::: {.panel}
## Top 3 Play Rates by Region {.panel-name}

```{r print-CardsTable-3}
TopPlayed.PbyReg <- TableCardsDT %>%
  group_by(region) %>%
  arrange(desc(p.byReg)) %>%
  top_n(3) %>%
  arrange(region) %>%
  rename_all(~c("Card","N","Region","RegionID","Games of X Region","Play Rate")) %>%
  select(c(1,3,6,2,5)) %>%
  datatable( ., rownames = FALSE, options = list(
    searching = FALSE,
    lengthChange = FALSE,
    pageLength = 4*9,
    info = FALSE)) %>%
  formatStyle('Card', fontWeight = 'bold') %>%
  formatStyle('Play Rate', fontWeight = 'bold') %>%
  formatStyle('Play Rate', fontWeight = 'bold') %>% formatStyle(
    'Region',
    target = 'row',
    backgroundColor = styleEqual(list.levels$factions.clean, list.levels$colorRegion.Balco)
  ) %>%
  formatPercentage('Play Rate', 1)

TopPlayed.PbyReg
```
:::

::: {.panel}
## Forgotten Cards {.panel-name}

Cards that couldn't find place even in a meme deck.

```{r missingCards, results='asis'}
missingCards <- unname(recodeCardsCode)[unname(recodeCardsCode) %!in% names(TableAllCards)]
missingCards.DT <- data.table( Card = as.character(fct_recode(missingCards,!!!recodeCardsCode)),
                               Code = missingCards,
                               Region = str_sub(missingCards,3,4)
                              )

# missingCards.DT <- setorderv(missingCards.DT, c("Region","Card"), c(1,1))

missColNames <- c("Region",list.levels$factions.clean[list.levels$regionShort %in% missingCards.DT$Region])

missingTable <- t(missingCards.DT[,c(1,3)] %>%
              group_by(Region) %>%
              mutate(n = row_number()) %>%
              spread(n, Card) %>%
              mutate(across(everything(), .fns = ~replace_na(.,""))) %>%
              mutate(Region = list.levels$factions.clean[list.levels$regionShort %in% Region]  )  
              ) %>%
              # setnames(.,list.levels$factions.clean) %>%
  kable("html", escape = F ) %>%
  # kable("html", escape = F, col.names = missColNames ) %>%
  kable_styling(bootstrap_options = c("hover"))

row.names(missingTable) <- NULL
missingTable
```
:::
:::::
<!-- Close Card Presence panelset -->

# Legal bla bla {.unnumbered}

This Meta Report was created under Riot Games' "Legal Jibber Jabber" policy using assets owned by Riot Games. Riot Games does not endorse or sponsor this project.