---
params:
  ind: "00"
  title: "From Curve to Cap"
  description: "Exploring Clustering Algorithms applied to Archetypes of Legends of Runeterra"
title: | 
  `r params$title`
description: |
  `r params$description`
# preview: 
base_url: https://www.llorr-stats.com
author:
  - name: Valentino (Legna) Vazzoler
date: 11-10-2021
output:
 distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 3
    self_contained: false
citation: false
bibliography: references.bib
draft: TRUE
---

- vS explained the concept of Skill-Cap by looking at the performances/win in the ladder by looking at the differences between Top Legends / DiamondI-IV
But differently for the Skill-Curve they don't look at the WR in function of games but at each MU-WR disparity ( which already big if it goes 2/3% )
They look at the single MU because the meta would easily influence the mean value ( and looking at what I have for PR between the two groups it is an obvious confounder)

Now, their example, Contact Rogue had a diff of 7.5% which is crazily high

So, now it's clearer why there is the problem I asked:
- Because a certain sample size is required also at top MMR  / in addition by taking the games from the start of the "top players" we know we can expect an higher WR because of the relationship between nGames and WR, but then, including games from when they were Plat+ seems wrong because of the definition


https://www.invenglobal.com/articles/15634/vs-zacho-grandmasters-are-not-immune-to-making-poor-judgment-calls-like-running-safety-inspector-in-paladin
- But I don't think any deck reached these kinds of numbers where the improvement is by well over 5% from upper Diamond to top legend. Decks rarely if ever reach a 3% overall matchup improvement.

Podcast info: ep.62 ~28:00

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo       = FALSE,
  eval       = TRUE,
  warning    = FALSE,
  error      = FALSE,
  message    = FALSE,
  comment    = NA,
  R.options  = list(width = 140, digits.secs=6),
  dev.args   = list(bg = 'whitesmoke'),
  fig.align  = 'center',
  fig.width  = 12,
  fig.height = 8,
  # fig.path   = "figures/prefix-"
  fig.path   = glue::glue("images/{params$ind}-"),
  layout     = "l-page",
  preview    = TRUE
)

#' R Option
options(scipen = 999)
source(file.path("C:","LlorR","scripts","lor_main.R" ))
source(file.path("C:","LlorR","scripts","functions","lor_constants.R"))
source(file.path("C:","LlorR","scripts","functions","lor_functions.R"))
xaringanExtra::use_panelset()

# Sys.setenv("_R_USE_PIPEBIND_" = TRUE) 
# mtcars |> 
#    . => lm(mpg ~ disp, data = .)
# 
# Sys.setenv("_R_USE_PIPEBIND_" = TRUE)
# mtcars |> d => lm(mpg ~ disp + wt, d)  # can even use . as the placeholder!
```

```{r panelset-style}
xaringanExtra::style_panelset_tabs(
  font_family        = "Helvetica",
  active_foreground  = "white",
  hover_foreground   = "black",
  hover_border_color = "black",
  active_background  = "#007fff"
  )
```



Ok, so to detail more the concept:
- vS explained the concept of Skill-Cap by looking at the performances/win in the ladder by looking at the differences between Top Legends / DiamondI-IV

Sometimes the fields is going to influence a deck winrates at different brackets -> if the meta over there is more favorable the wr is expceted to be higher

But after removing all otherr factors and seeing the disparity in MU

But differently for the Skill-Curve they don't look at the WR in function of games but at each MU-WR disparity ( which already big if it goes 2/3% is alreadu considered extremely high skill-cap it is historically high )
They look at the single MU because the meta would easily influence the mean value ( and looking at what I have for PR between the two groups it is an obvious confounder)

Now, their example, Contact Rogue had a diff of 7.5% which is crazily high

So, now it's clearer why there is the problem I asked:
- Because a certain sample size is required also at top MMR  / in addition by taking the games from the start of the "top players" we know we can expect an higher WR because of the relationship between nGames and WR, but then, including games from when they were Plat+ seems wrong because of the definition

Podcast info: ep.62 ~28:00

if something is good only at top100 one can assume it's only the player's skill



```{r raw-data}
# load DeckDT
LoR.Deck.RMD       <- fread(file.path("C:","LlorR","data","raw","LoR_DECK.csv"),na.strings = c("",NA))

# load Games DT
LoR.Account.RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)ACCOUNT(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread,colClasses = "character",header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(activeShard = if_else(activeShard %in% c("sea","asia"),"apac",activeShard) ) |>
  mutate(RiotID = glue::glue("{gameName}#{tagLine}")) |>
  distinct(puuid,.keep_all = T)

# load Seasonal
LoR.Seasonal.DT.RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw","games"), pattern = glue("^(.*)Seasonal(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread,header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea","asia"),"apac",server) )

# load Temp DT
LoR.Temp.DT.RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw","games"), pattern = glue("^(.*)Temp_DT_S12(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread,header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea","asia"),"apac",server) )

# load Games DT
LoR.Match.DT.RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)Match_DT_S12(.*)csv$"), full.names = T) |>
  str_subset(pattern = "Keys",negate = T) |>
  map_dfr(data.table::fread,header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea","asia"),"apac",server) )

# load Games DT
LoR.Diamond.DT.RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)Diamond_DT_S12(.*)csv$"), full.names = T) |>
  str_subset(pattern = "Keys",negate = T) |>
  map_dfr(data.table::fread,header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea","asia"),"apac",server) )
```

```{r players-select}
LoR.Seasonal.DT.RMD |>
  # filter(game_version == max(game_version) ) |>
  filter(game_version == "live_3_01_12" ) |>
  select(match_key,starts_with("puuid")) |>
  pivot_longer(-match_key,values_to = "puuid") |>
  distinct(puuid) |>
  pull() -> puuid_seasonal
```

```{r temp}
LoR.Melt.Temp.RMD <- LoR.Temp.DT.RMD |>
  filter(game_mode == "Constructed") |>
  filter(game_start_time_utc >= as_datetime("2022-02-16 19:00:00") ) |>
  select(-contains("factions")) |>
  rename(playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
  mutate(opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
  mutate(opponent_deck_code_1 = deck_code_2, opponent_deck_code_2 = deck_code_1 ) |>
  pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
               names_to = c(".value"),
               names_pattern = "(.*)_[0-9]"
               ) |>
  as.data.table() |>
  # Add Deck data
  left_join(LoR.Deck.RMD, by="deck_code") |>
  rename(playerDeck=archetype) |>
  left_join(
    LoR.Deck.RMD[,.(deck_code,opponentDeck=archetype)],
    by=c("opponent_deck_code"="deck_code")) |>
  # Add Player data
  left_join(LoR.Account.RMD[,.(puuid,playerID=RiotID)]   ,by=c("playerPuuid"="puuid")) |>
  left_join(LoR.Account.RMD[,.(puuid,opponentID=RiotID)] ,by=c("opponentPuuid"="puuid"))
```

```{r diamond}
LoR.Melt.Diamond.RMD <- LoR.Diamond.DT.RMD |>
  filter(game_mode == "Constructed") |>
  filter(game_start_time_utc >= as_datetime("2022-02-16 19:00:00") ) |>
  select(-contains("factions")) |>
  rename(playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
  mutate(opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
  mutate(opponent_deck_code_1 = deck_code_2, opponent_deck_code_2 = deck_code_1 ) |>
  pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
               names_to = c(".value"),
               names_pattern = "(.*)_[0-9]"
               ) |>
  as.data.table() |>
  # Add Deck data
  left_join(LoR.Deck.RMD, by="deck_code") |>
  rename(playerDeck=archetype) |>
  left_join(
    LoR.Deck.RMD[,.(deck_code,opponentDeck=archetype)],
    by=c("opponent_deck_code"="deck_code")) |>
  # Add Player data
  left_join(LoR.Account.RMD[,.(puuid,playerID=RiotID)]   ,by=c("playerPuuid"="puuid")) |>
  left_join(LoR.Account.RMD[,.(puuid,opponentID=RiotID)] ,by=c("opponentPuuid"="puuid"))
```

```{r master}
LoR.Melt.Master.RMD <- LoR.Match.DT.RMD |>
  filter(game_mode == "Constructed") |>
  filter(game_start_time_utc >= as_datetime("2022-02-16 19:00:00") ) |>
  select(-contains("factions")) |>
  rename(playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
  mutate(opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
  mutate(opponent_deck_code_1 = deck_code_2, opponent_deck_code_2 = deck_code_1 ) |>
  pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
               names_to = c(".value"),
               names_pattern = "(.*)_[0-9]"
               ) |>
  as.data.table() |>
  # Add Deck data
  left_join(LoR.Deck.RMD, by="deck_code") |>
  rename(playerDeck=archetype) |>
  left_join(
    LoR.Deck.RMD[,.(deck_code,opponentDeck=archetype)],
    by=c("opponent_deck_code"="deck_code")) |>
  # Add Player data
  left_join(LoR.Account.RMD[,.(puuid,playerID=RiotID)]   ,by=c("playerPuuid"="puuid")) |>
  left_join(LoR.Account.RMD[,.(puuid,opponentID=RiotID)] ,by=c("opponentPuuid"="puuid"))
```

```{r melt-data}
# LoR.Melt.Games.RMD <- LoR.Temp.DT.RMD |>
#   bind_rows(LoR.Match.DT.RMD) |>
#   bind_rows(LoR.Diamond.DT.RMD) |>
#   filter(game_mode == "Constructed") |>
#   filter(puuid_1 %in% puuid_seasonal | puuid_2 %in% puuid_seasonal) |>
#   distinct(match_key,.keep_all = T) |>
#   filter(game_start_time_utc >= as_datetime("2022-02-16 19:00:00") ) |>
#   # filter(game_type == "Ranked") |>
#   select(-contains("factions")) |>
#   rename(playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
#   mutate(opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
#   mutate(opponent_deck_code_1 = deck_code_2, opponent_deck_code_2 = deck_code_1 ) |>
#   pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
#                names_to = c(".value"),
#                names_pattern = "(.*)_[0-9]"
#                ) |>
#   as.data.table() |>
#   # Add Deck data
#   left_join(LoR.Deck.RMD, by="deck_code") |>
#   rename(playerDeck=archetype) |>
#   left_join(
#     LoR.Deck.RMD[,.(deck_code,opponentDeck=archetype)],
#     by=c("opponent_deck_code"="deck_code")) |>
#   # Add Player data
#   left_join(LoR.Account.RMD[,.(puuid,playerID=RiotID)]   ,by=c("playerPuuid"="puuid")) |>
#   left_join(LoR.Account.RMD[,.(puuid,opponentID=RiotID)] ,by=c("opponentPuuid"="puuid"))
```

```{r}
nMU <- 30

MasterOnly <- LoR.Melt.Master.RMD |>
  anti_join(LoR.Melt.Diamond.RMD,by = c("match_key","playerPuuid"))

DiamondOnly <- LoR.Melt.Diamond.RMD |>
  anti_join(LoR.Melt.Master.RMD,by = c("match_key","playerPuuid"))

MasterOnly |>
  bind_rows(DiamondOnly) |>
  count(playerDeck) |>
  slice_max(n,n=nMU) |>
  pull(playerDeck) -> decks_top

# # only decks with at least 100 games
# MU_Master |>
#   filter(playerDeck == deck) |>
#   filter(muGames >= 100) |>
#   pull(opponentDeck) -> deck_min_100

MU_Master <-  MasterOnly |>
  match_ups() |>
  filter(playerDeck %in% decks_top & opponentDeck %in% decks_top) |>
  filter(playerDeck != opponentDeck) |>
  add_column(rank = "master")

MU_Diamond <- DiamondOnly |>
  match_ups() |>
  filter(playerDeck %in% decks_top & opponentDeck %in% decks_top) |>
  filter(playerDeck != opponentDeck)  |>
  add_column(rank = "diamond")
```

```{r darkness, fig.width  = 12, fig.height = 8}

deck  <- "Senna/Veigar"
decks <- decks_top[1:20]
# decks <- deck_min_100

MU_Master |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  rename(muMaster=muWR) |>
  mutate(w = muGames/sum(muGames)) |>
  select(1,2,5,last_col()) |>
  left_join(
    MU_Diamond |>
      filter(playerDeck==deck) |>
      filter(opponentDeck %in% decks) |>
      rename(muDiamond=muWR) |>
      mutate(w = muGames/sum(muGames)) |>
      select(1,2,5),
      # select(1,2,5,last_col()),
    by = c("playerDeck","opponentDeck")
  ) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  arrange(opponentDeck) |>
  mutate(diffMU = muMaster-muDiamond) |>
  # pull(diffMU) -> vec_diff
  mutate(mean_diffMU = cummean(diffMU)) |>
  select(opponentDeck,mean_diffMU) |>
  mutate(wr_label=scales::percent(mean_diffMU,accuracy = 0.1) ) -> diffDT



MU_Master |>
  bind_rows(MU_Diamond) |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  mutate(rank = factor(rank, levels = c("master","diamond"), ordered = TRUE) ) |>
  # mutate(opponentDeck = fct_reorder(opponentDeck, muGames, .desc = TRUE) ) |>
  ggplot() +
  geom_errorbar(aes(x=opponentDeck,ymin=LCI,ymax=UCI,color=rank),
                position = position_dodge(0.3),width = 0.2) +
  geom_point(aes(x=opponentDeck,y=muWR,color = rank), position = position_dodge(0.3)) +
  geom_line(data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,group = 1), size=1.2,linetype=2, color="darkviolet") +
  geom_label_repel(
    data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,label=wr_label,group = 1),
    family = "Helvetica",fontface = "bold", size = 3.5, direction = "y", force = 3, hjust = 1, segment.size = .7, segment.alpha = .5, segment.linetype = "dotted", box.padding = .4,
    segment.curvature = -0.1, segment.ncp = 3, segment.angle = 15, fill = "#f0f0f0", label.padding = 0, label.size = 0
  ) +
  expand_limits(y=0) +
  scale_y_continuous(
    breaks=seq(0,1,0.25),
    # Add a second axis and specify its features
    labels = scales::percent_format(accuracy = 1),
    sec.axis =  dup_axis(trans=~./10,breaks = seq(0,0.1,0.02), name="Win Rate difference")
  ) +
  labs(title = glue::glue("{deck} Skill-Cap Gap Plot"),
       subtitle = "Difference in Win-Rates",
       caption = "Left Y-axis are the win-rates") +
  theme_Publication() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.85, hjust=1, size = 10)) +
  scale_colour_Publication()
```
```{r lurk, fig.width  = 12, fig.height = 8}

deck  <- "Pyke/Rek'Sai"
decks <- decks_top[1:20]
# decks <- deck_min_100

MU_Master |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  rename(muMaster=muWR) |>
  mutate(w = muGames/sum(muGames)) |>
  select(1,2,5,last_col()) |>
  left_join(
    MU_Diamond |>
      filter(playerDeck==deck) |>
      filter(opponentDeck %in% decks) |>
      rename(muDiamond=muWR) |>
      mutate(w = muGames/sum(muGames)) |>
      select(1,2,5),
      # select(1,2,5,last_col()),
    by = c("playerDeck","opponentDeck")
  ) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  arrange(opponentDeck) |>
  mutate(diffMU = muMaster-muDiamond) |>
  # pull(diffMU) -> vec_diff
  mutate(mean_diffMU = cummean(diffMU)) |>
  select(opponentDeck,mean_diffMU) |>
  mutate(wr_label=scales::percent(mean_diffMU,accuracy = 0.1) ) -> diffDT



MU_Master |>
  bind_rows(MU_Diamond) |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  mutate(rank = factor(rank, levels = c("master","diamond"), ordered = TRUE) ) |>
  # mutate(opponentDeck = fct_reorder(opponentDeck, muGames, .desc = TRUE) ) |>
  ggplot() +
  geom_errorbar(aes(x=opponentDeck,ymin=LCI,ymax=UCI,color=rank),
                position = position_dodge(0.3),width = 0.2) +
  geom_point(aes(x=opponentDeck,y=muWR,color = rank), position = position_dodge(0.3)) +
  geom_line(data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,group = 1), size=1.2,linetype=2, color="darkviolet") +
  geom_label_repel(
    data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,label=wr_label,group = 1),
    family = "Helvetica",fontface = "bold", size = 3.5, direction = "y", force = 3, hjust = 1, segment.size = .7, segment.alpha = .5, segment.linetype = "dotted", box.padding = .4,
    segment.curvature = -0.1, segment.ncp = 3, segment.angle = 15, fill = "#f0f0f0", label.padding = 0, label.size = 0
  ) +
  expand_limits(y=0) +
  scale_y_continuous(
    breaks=seq(0,1,0.25),
    # Add a second axis and specify its features
    labels = scales::percent_format(accuracy = 1),
    sec.axis =  dup_axis(trans=~./10,breaks = seq(0,0.1,0.02), name="Win Rate difference")
  ) +
  labs(title = glue::glue("{deck} Skill-Cap Gap Plot"),
       subtitle = "Difference in Win-Rates",
       caption = "Left Y-axis are the win-rates") +
  theme_Publication() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.85, hjust=1, size = 10)) +
  scale_colour_Publication()
```

```{r war-on-yuumi, fig.width  = 12, fig.height = 8}

deck  <- decks_top[3]
decks <- decks_top[4:20]
# decks <- deck_min_100

MU_Master |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  rename(muMaster=muWR) |>
  mutate(w = muGames/sum(muGames)) |>
  select(1,2,5,last_col()) |>
  left_join(
    MU_Diamond |>
      filter(playerDeck==deck) |>
      filter(opponentDeck %in% decks) |>
      rename(muDiamond=muWR) |>
      mutate(w = muGames/sum(muGames)) |>
      select(1,2,5),
      # select(1,2,5,last_col()),
    by = c("playerDeck","opponentDeck")
  ) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  arrange(opponentDeck) |>
  mutate(diffMU = muMaster-muDiamond) |>
  # pull(diffMU) -> vec_diff
  mutate(mean_diffMU = cummean(diffMU)) |>
  select(opponentDeck,mean_diffMU) |>
  mutate(wr_label=scales::percent(mean_diffMU,accuracy = 0.1) ) -> diffDT



MU_Master |>
  bind_rows(MU_Diamond) |>
  filter(playerDeck==deck) |>
  filter(opponentDeck %in% decks) |>
  mutate(opponentDeck = factor(opponentDeck, levels = decks, ordered = TRUE) ) |>
  mutate(rank = factor(rank, levels = c("master","diamond"), ordered = TRUE) ) |>
  # mutate(opponentDeck = fct_reorder(opponentDeck, muGames, .desc = TRUE) ) |>
  ggplot() +
  geom_errorbar(aes(x=opponentDeck,ymin=LCI,ymax=UCI,color=rank),
                position = position_dodge(0.3),width = 0.2) +
  geom_point(aes(x=opponentDeck,y=muWR,color = rank), position = position_dodge(0.3)) +
  geom_line(data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,group = 1), size=1.2,linetype=2, color="darkviolet") +
  geom_label_repel(
    data=diffDT,aes(x=opponentDeck,y=mean_diffMU*10,label=wr_label,group = 1),
    family = "Helvetica",fontface = "bold", size = 3.5, direction = "y", force = 3, hjust = 1, segment.size = .7, segment.alpha = .5, segment.linetype = "dotted", box.padding = .4,
    segment.curvature = -0.1, segment.ncp = 3, segment.angle = 15, fill = "#f0f0f0", label.padding = 0, label.size = 0
  ) +
  expand_limits(y=0) +
  scale_y_continuous(
    breaks=seq(0,1,0.25),
    # Add a second axis and specify its features
    labels = scales::percent_format(accuracy = 1),
    sec.axis =  dup_axis(trans=~./10,breaks = seq(0,0.1,0.02), name="Win Rate difference")
  ) +
  labs(title = glue::glue("{deck} Skill-Cap Gap Plot"),
       subtitle = "Difference in Win-Rates",
       caption = "Left Y-axis are the win-rates") +
  theme_Publication() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.85, hjust=1, size = 10)) +
  scale_colour_Publication()
```
