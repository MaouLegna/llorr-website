---
title: "MATCH UP TABLE - PATCH 2.12/2.13"
description: |
base_url: https://llorr-stats.netlify.app
# preview: "https://static.wikia.nocookie.net/leagueoflegends/images/d/df/03NX007T1_Sentinel-full.png"
# date: 07-21-2021
output: distill::distill_article
    # toc: true
    # toc_float: true
    # toc_depth: 3
    # self_contained: false
draft: false
twitter:
  site: "@Maou_Legna"
  creator: "@Maou_Legna"
params:
  # prev:  "2021-07-07 21:00:00" #UTC tz / 'previous' week start
  start: "2021-07-14 21:00:00" #UTC tz / 'current' week start
  # end:   "2021-07-21 21:00:00" #UTC tz / 'current' week end
  skip:  1888233  # Patch 2.11 - after removing a few games
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  dev.args = list(bg = 'transparent'),
  # dev='svglite',
  fig.align='center',
  #out.width='75%', fig.asp=.75,
  cache.rebuild = F,
  cache = F
)

# source(file.path("C:","LlorR","scripts","lor_main.R" ))
options(digits.secs = 6)
options(scipen=999)

#' R Option
xaringanExtra::use_panelset()

pacman::p_load(tidyverse,
               data.table,
               DT,
               reactable,
               crosstalk)
```

```{r panelset-style}
xaringanExtra::style_panelset_tabs(font_family = "Roboto",
                                   active_foreground = "white",
                                   hover_foreground = "black",
                                   hover_border_color = "black",
                                   active_background = "#007fff"
                                   )
```

```{r load-data}
# file.Match.DT   <- list.files(path = file.path("C:","LlorR","data","clean" ), pattern = "LoR_Melt_MatchDT_", full.names = T) %>% max()
# LoR.Melt.Matches.RMD <- fread(file.Match.DT, header = T, na.strings = c("", NA))
```

```{r load-MU}
file.MU.DT   <- list.files(path = file.path("C:","LlorR","data","clean" ), pattern = "MUtbl_", full.names = T) %>% max()
MUtbl <- fread(file.MU.DT, header = T, na.strings = c("", NA))
```

# Match Up Table

Number of **matches**: `r sum(MUtbl$muGames)/2` / **games** : `r sum(MUtbl$muGames)`

Last Update: `r Sys.time()`

Since the values aren't too heavily affected by new data I won't update it too often. Will probably be each 2 days or so (more often at the start of a season). [^1]

[^1]: since I had to implement a couple of corrections I can 'confirm' that updating the file is a bit heavy sometimes to my 'potato pc', even worse if it happens during the data collection. So I have to confirm I can't update it hourly/all days as I would ideally.

While on the report I do some filtering removing cases with too few games, here I left EVERYTHING to allows people plays as much as they want with the table (as usual from Ranked games), so if you want to remove "the dirt" **remember to use the filter**.

**Update**: added an "alternative" version to the same MU table. Should result a bit cleaner. Potentially I may turn it into the standard version once I know how to improve a few things like the slider-input bur for now I leave both options. Also the removed cases with less than 10 games (that alone is enough to reduce to 1/10th of the original rows). The "standard" one is still with everything.

::: l-screen

::::: {.panelset}
::: {.panel}

### Standard - No filters {.panel-name}

```{r DTtbl-version}
MUtbl %>%
  # filter(muGames>10) %>%
  mutate( direction = replace(direction, muWR==0.5, "TIE" ) ) %>%
  mutate( player = factor(player), opponent = factor(opponent), direction = factor(direction), okCI = factor(okCI) ) %>%
  select( -CI ) %>%
  datatable(., rownames = FALSE,
            colnames = c('Player'='player','Opponent'='opponent','Regions'='factions','Win Rate'='muWR','#Wins'='muWin','#Games'='muGames','LowerCI'='LCI','UpperCI'='UCI','Direction MU'='direction','Result Test'='okCI',"Play Rate"='playrate'),
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = "_all"))
            ),
            filter = list(position = 'top', clear = FALSE)
  ) %>%
  formatPercentage('Win Rate', 1) %>%
  formatPercentage('LowerCI', 1) %>%
  formatPercentage('UpperCI', 1) %>%
  formatPercentage('Play Rate', 1)
```
:::

::: {.panel}
### Alternative {.panel-name}

```{r reactable-tbl}
require(reactable)
require(htmltools)

data <- SharedData$new(MUtbl %>% 
                         filter(muGames>=10) %>%
  mutate( direction = replace(direction, muWR==0.5, "TIE" ) ) %>%
  mutate( player = factor(player), opponent = factor(opponent), direction = factor(direction), okCI = factor(okCI) ) %>%
  select( -CI ))

bscols(
  widths = c(3, 9),
  list(
    filter_select("player", "Player", data, ~player),
    filter_select("opponent", "Opponent", data, ~opponent),
    filter_slider("muWin",   "#Win", data, ~muWin, width = "100%",step = 50,min = 0),
    filter_slider("muGames", "#Games", data, ~muGames, width = "100%",step = 50,min = 0),
    filter_slider("muWR", "WinRate", data, ~muWR, width = "100%",step=0.01,min = 0,max = 1),
    filter_slider("LCI", "LowerCI", data, ~LCI, width = "100%",step=0.01,  min = 0,max = 1),
    filter_slider("UCI", "UpperCI", data, ~UCI, width = "100%",step=0.01,  min = 0,max = 1),
    filter_select("okCI", "Result Test", data, ~okCI)
    
    # filter_checkbox("type", "Type", data, ~Type),
    # filter_slider("price", "Price", data, ~Price, width = "100%"),
    # filter_select("mfr", "Manufacturer", data, ~Manufacturer)
  ),
  reactable(data,
            bordered = TRUE,
            highlight = TRUE,
            striped = TRUE,
            searchable = TRUE,
            # filterable = TRUE,
             defaultColDef = colDef(
              # header = function(value) str_to_title(value),
              #  cell = function(value) format(value, nsmall = 1),
              align = "center",
              minWidth = 120,
              headerStyle = list(background = "steelblue",color="white")
            ),
            columns = list(
              player   = colDef(name = "Player",minWidth = 120),
              opponent = colDef(name = "Opponent"  ,minWidth = 120),
              factions = colDef(name = "Regions"),
              muWin    = colDef(name = "#Win"),
              muGames  = colDef(name = "#Games"),
              muWR     = colDef(name = "WinRate",format = colFormat(percent = TRUE,digits = 1) ),
              LCI      = colDef(name = "LowerCI",format = colFormat(percent = TRUE,digits = 1)),
              UCI      = colDef(name = "UpperCI",format = colFormat(percent = TRUE,digits = 1)),
              direction= colDef(name = "Direction"),
              okCI     = colDef(name = "Result Test"),
              playrate = colDef(name = "playrate",format = colFormat(percent = TRUE,digits = 1))),
            theme = reactableTheme(
                borderColor = "#dfe2e5",
                stripedColor = "#f6f8fa",
                highlightColor = "#f0f5f9",
                cellPadding = "8px 12px",
                style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"),
                searchInputStyle = list(width = "100%"))
    )
)
```
:::
:::::

:::

The format of the table is the usual way I display the match-ups data but I also displayed additional variables that I normally remove in the report:

* **Regions** - regions of the 'Player' deck. In case I may add an 'Oppo-Region' additional column.

* **LowerCI / UpperCI** - are simply the lower and upper bound of the confidence interval, it can help in case one to restrict the result based on the "precision" of the win rate estimation (not the correct statistical definition but a 'semplification').

* **Result Test** - if true it means that the unidirectional test for testing if the **direction** of the MU is correct has a p-value lower than 0.05 (it reject the hyphotesis of the win rate being a 0.5 giving support to the hypothesis that the direction of the MU is indeed correct. Again not the exact definmition. Use to filter the results that is safer to assume are correct regarding the **direction** of the MU.

* **Direction MU** - simply if the MU is positive or negative for the 'Player' (or tie in case the win rate is exactly 0.5)

I'm planning to improve and expand the options once I decide how to implement the ideas I have.

```{r}
# # not good practice since big dependency and all we want is slider
# #   but for demonstration purposes do it this way
# material_dep <- htmlDependency(
#   name = "material-ui",
#   version = "4.6.1",
#   src = c(href = "https://unpkg.com/@material-ui/core/umd/"),
#   script = "material-ui.production.min.js"
# )
# 
# rt <- reactable(
#   iris,
#   filterable = TRUE
# )
# 
# rt$x$tag$attribs$columns[[2]]$filterMethod <- htmlwidgets::JS("filterRange")
# rt$x$tag$attribs$columns[[2]]$Filter <- htmlwidgets::JS("inputFilter")
# 
# browsable(
#   tagList(
#     reactR::html_dependency_react(),
#     reactR::html_dependency_reacttools(),
#     htmlwidgets::getDependency("reactable","reactable"),
#     material_dep,
#     tags$style("
# .rt-thead.-filters .rt-tr {align-items: flex-end; height: 60px;}
# .rt-thead.-filters .rt-th {overflow: visible;}
#     "),
#     tags$script(HTML("
# function filterRange(filter, rows) {
#   return rows.filter(function(row) {
#     // Don't filter on aggregated cells
#     if (row._subRows) {
#       return true
#     }
#     return row[filter.id] >= filter.value[0] && row[filter.id] <= filter.value[1];
#   })
# }
# 
# function inputFilter(filter) {
#   var _onChange = filter.onChange;
#   return React.createElement(
#     'div',
#     null,
#     React.createElement(
#       MaterialUI.Slider,
#       {
#         defaultValue: [0,5],
#         min: 0,
#         max: 5,
#         step: 0.5,
#         valueLabelDisplay: 'auto',
#         onChange: function onChange(event, newValue) {return _onChange(newValue)}
#       }
#     )
#   )
# }
#     ")),
#     rt
#   )
# )
```

