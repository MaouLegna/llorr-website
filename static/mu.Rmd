---
title: "Match Ups Data (from Patch 2.21 onward)"
author: "by Legna"
output:
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-trophy", text: "Meta", href: "https://www.llorr-stats.com/static/meta.html", align: right }
      - { icon: "fa-home", href: "https://www.llorr-stats.com", align: right }
    # orientation: columns
    # vertical_layout: fill
    orientation: row
# date: "`r Sys.Date()`"
params:
  # start:   "2021-06-02 18:00:00" #UTC tz / 2.09 <- Balance Patch
  # start:   "2021-06-30 18:00:00" #UTC tz / 2.11 <- Rose of the Underworld
  # start:   "2021-07-14 18:00:00" #UTC tz / 2.12 <- Ruination Event
  # end:     "2021-08-25 18:00:00" #UTC tz / 2.14 <- Bandle Release
  # start:   "2021-09-01 18:00:00" #UTC tz / 2.14 <- World Patch to 2.18 ( one week later because of world patch )
  # start:   "2021-10-20 18:00:00" #UTC tz / 2.18 <- Balance Patch
  start:   "2021-12-08 18:00:00" #UTC tz / 2.21 <- Set & Balance Patch
  end:     "2022-01-31 18:00:00" #UTC tz /
  minMUGames: 10 # min number of games for a MU
  nGrid: 15      # how many MU to plot
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  comment = NA,
  R.options = list(width = 140,
                   digits.secs=6),
  dev.args = list(bg = 'transparent'), # make graphics with transparent background
  fig.align = 'center',
  fig.width=12,
  fig.height=8,
  engine.path = list(
    python = 'C:/anaconda/'   # -> use_python("C:/anaconda/")
  ),
  #'distill options
  layout="l-body-outset",
  preview=FALSE
)

#' R Option
options(scipen = 999)
source(file.path("C:","LlorR","scripts","lor_main.R"))
xaringanExtra::use_panelset()
```

```{r load-data}
#' load DeckDT
#'############
LoR.Deck.RMD       <- fread(file.path("C:","LlorR","data","raw","LoR_DECK.csv"),na.strings = c("",NA))

#' load Games DT
#'##############
# LoR.Match.DT.RMD    <- fread(file.path("C:","LlorR","data","raw","LoR_MatchDT.csv"), header = T, na.strings = c("", NA))
LoR.Match.DT.RMD      <- fread(file.path("C:","LlorR","data","raw","LoR_TempDT.csv"), header = T, na.strings = c("", NA))

#' Read Diamond DT
##################
LoR.Diamond.DT.RMD <- fread(file.path("C:","LlorR","data","raw","LoR_TempDT.csv"), header = T, na.strings = c("",NA))

# LoR.Account.RMD <- fread(file.path("C:","LlorR","data","raw","LoR_ACCOUNT.csv"),header=T, na.strings = c("",NA), encoding = 'UTF-8') |>
#   mutate( RiotID = sprintf("%s#%s",gameName,tagLine) )
```

```{r functions}
# Render a bar chart with positive and negative values
bar_chart_pos_neg <- function(label, value, max_value = 1, height = "12px",pos_fill = "#005ab5", neg_fill = "#dc3220") {
  
  base_chart <- htmltools::div(style = list(flex = "1 1"))
  # pos_chart <- htmltools::div(style = list(flex = "1 1"))
  width <- paste0((value / max_value) * 100, "%")

  if (value >= 0.5) {
    bar <- htmltools::div(style = list(marginLeft = "8px",marginRight = "8px", background = pos_fill, width = width, height = height))
    chart <- htmltools::div(style = list(display = "flex", alignItems = "center"), bar, label)
    base_chart <- htmltools::tagAppendChild(base_chart, chart)
    htmltools::div(style = list(display = "flex"), base_chart)
  } else {
    bar <- htmltools::div(style = list(marginLeft = "8px",marginRight = "8px", background = neg_fill, width = width, height = height))
    chart <- htmltools::div(style = list(display = "flex", alignItems = "center"), bar, label)
    base_chart <- htmltools::tagAppendChild(base_chart, chart)
    htmltools::div(style = list(display = "flex"), base_chart)
  }
}
```

```{r constants}
LastUpdate.box <- flexdashboard::valueBox(Sys.Date(),
                                          caption = glue::glue("Last Update / Usually done around 5:00 UTC / 7:00 CET"),
                                          icon = "fa-clock",
                                          # color = "lightgreen"
                                          color = "#1A9850")
```

```{r archetype-fix}
# Limit the Deck DT to make the fixes much faster
deck_filter <- do.call("rbind", mget(ls(pattern="\\.DT.RMD$")) ) |>
  #' Base filters
  filter( game_type=="Ranked" ) |>
  filter( game_start_time_utc > as.POSIXct(params$start, tz = "UTC") ) |>
  select(deck_code_1,deck_code_2) |>
  pivot_longer( cols = contains("deck_code"),values_to = "decks" ) |>
  filter(decks!="") |>
  distinct(decks)

LoR.Deck.RMD <- LoR.Deck.RMD[deck_code %in% deck_filter$decks]

#' Archetype-Fix
#'##############
source(file.path("C:","LlorR","scripts","functions","lor_archetype_rmd.R"))

# LoR.Deck.RMD[ ,tabyl(archetype_pretty) ]

#' Archetype names fix
######################
LoR.Deck.RMD[ !is.na(archetype_pretty), archetype:=archetype_pretty ]
```

# fromSeasonal-Only {data-icon="fa-table"}

```{r prepara-data}
LoR.Melt.Matches.RMD <- LoR.Match.DT.RMD |>
  filter( game_type=="Ranked" ) |>
  filter( game_start_time_utc >= as.POSIXct(params$start,"UTC") & game_start_time_utc < as.POSIXct(params$end,"UTC") ) |>
  left_join(LoR.Deck.RMD[,.(deck_code,playerDeck_1=archetype)],  by=c("deck_code_1"="deck_code")) |>
  left_join(LoR.Deck.RMD[,.(deck_code,opponentDeck_1=archetype)],by=c("deck_code_2"="deck_code")) |>
  rename( playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
  mutate( playerDeck_2 = opponentDeck_1, opponentDeck_2 = playerDeck_1, opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
  pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
               names_to = c(".value"),
               names_pattern = "(.*)_[0-9]"
               ) |>
  as.data.table()

# LoR.Melt.Matches.RMD[ is.na(playerDeck), .N ]
```

```{r}
# LoR.Melt.Matches.RMD <- LoR.Match.DT.RMD |> 
#   filter( game_type == "Ranked"  ) |>
#   filter( game_start_time_utc >= as.POSIXct(params$start,"UTC") & game_start_time_utc < as.POSIXct(params$end,"UTC") ) |>
#   select( -ends_with("_3"),-ends_with("_4"),-starts_with("factions")) |>
#   # since I use a different format for factions in LoR.Deck
#   left_join(LoR.Deck.RMD[,.(deck_code,factions_1=factions,playerDeck_1=archetype)],  by=c("deck_code_1"="deck_code")) |>
#   left_join(LoR.Deck.RMD[,.(deck_code,factions_2=factions,opponentDeck_1=archetype)],by=c("deck_code_2"="deck_code")) |>
#   rename( playerPuuid_1 = puuid_1, playerPuuid_2 = puuid_2 ) |>
#   mutate( playerDeck_2 = opponentDeck_1, opponentDeck_2 = playerDeck_1, opponentPuuid_1 = playerPuuid_2, opponentPuuid_2 = playerPuuid_1 ) |>
#   pivot_longer(cols = c(ends_with("_1"),ends_with("_2")),
#                names_to = c(".value"),
#                names_pattern = "(.*)_[0-9]"
#                ) |>
#   #' finish 'process' data
#   left_join(LoR.Account.RMD[,.(puuid,playerID=RiotID)]   ,by=c("playerPuuid"="puuid")) |>
#   left_join(LoR.Account.RMD[,.(puuid,opponentID=RiotID)] ,by=c("opponentPuuid"="puuid")) |>
#   left_join(LoR.Deck.RMD |> select(-archetype,-factions),by="deck_code") |>
#   as.data.table()
# 
# LoR.Account.RMD |>
#   mutate(gameName = str_to_lower(gameName)) |>
#   filter(seasonal == "seasonal") |>
#   # filter(str_detect(gameName,"moe" )  )
#   filter(gameName %in% c("akaido","shadawx","emoetional") )
# 
# LoR.Melt.Matches.RMD |>
#   filter(playerID %in% c("eMOEtional#1738","Shadawx#NA1")) |>
#   filter(str_detect(cards,getCardCode("Minion")) ) |>
#   distinct(deck_code)
```


```{r process-MU-master}
#' WR tbl
#'#######
WR.DT <- LoR.Melt.Matches.RMD |>
  filter(game_outcome!="tie") |>
  select( playerDeck,opponentDeck,game_outcome ) |>
  group_by(playerDeck) |>
  summarise( 
    nWin   = sum(game_outcome=="win"),
    nGames = n(),
    WR=mean(game_outcome=="win")
  ) |>
  ungroup() |>
  mutate( playrate = nGames/sum(nGames) ) |>
  as.data.table()

#' MU tbl the date is already filtered
#'####################################
MUtbl <- LoR.Melt.Matches.RMD |>
  filter( game_outcome != "tie" ) |>
  select( playerDeck,opponentDeck,game_outcome,server,game_version,factions ) |>
  group_by(playerDeck,opponentDeck,factions) |>
  summarise( 
    muWin   = sum(game_outcome=="win"),
    muGames = n(),
    muWR=mean(game_outcome=="win")
    ) |>
  ungroup() |>
  filter(muGames >= params$minMUGames) |>
  mutate(
    factions = map_chr(.x = factions, ~str_remove_all(.x, paste(c("_Name","faction_", ""), collapse = "|") ) ),
    CI   = map2_df(.x=muWin,.y = muGames, .f = ~binom::binom.confint(.x,.y,0.95,methods="exact")[,c("lower","upper")] )
    ) |>
  chop(CI) |>
  unnest(CI) |>
  mutate( 
    okCI = map2_lgl(.x = lower,.y = upper, ~ !between(0.50,.x,.y) ) ,
    direction = ifelse(muWR>0.50,"POS","NEG"),
    direction = replace(direction,direction==0.50,"TIE"),
    CI := glue::glue("({scales::percent(lower,accuracy = 0.1)}-{scales::percent(upper,accuracy = 0.1)})" ),
    mirror = ifelse(playerDeck==opponentDeck,"Yes","No" )
    ) |>
  # removing ~extra variables
  select(-lower,-upper) |>
  left_join(WR.DT[,.(playerDeck,playrate)],by="playerDeck") |>
  left_join(WR.DT[,.(playerDeck,opponentPR=playrate)],by=c("opponentDeck"="playerDeck") ) |>
  relocate(factions,.after = muWR)
```

## Inputs {.sidebar}

### Filters

```{r filters}
data <- crosstalk::SharedData$new( MUtbl )

crosstalk::filter_select("playerDeck", "Player's Deck", data, ~playerDeck)
crosstalk::filter_select("opponentDeck", "Opponent's Deck", data, ~opponentDeck)

crosstalk::filter_slider("muWin",   "#Win",  data, ~muWin,   step = 50 ,min = 0)
crosstalk::filter_slider("muGames", "#Games",data, ~muGames, step = 100,min = 0)

crosstalk::filter_slider("muWR", "WinRate", data, ~muWR,step=0.01,min = 0,max = 1)
crosstalk::filter_slider("playrate", "Player PlayRate", data, ~playrate,step=0.01,min = 0,max = round(max(MUtbl$playrate),4) )
crosstalk::filter_slider("opponentPR", "Opponent PlayRate", data, ~opponentPR,step=0.01,min = 0,max = round(max(MUtbl$opponentPR),4) )

crosstalk::filter_select("direction", "MU-Direction", data, ~direction)
crosstalk::filter_checkbox("mirror", "Mirror", data, ~mirror, inline = TRUE)
```

## Row {data-heigth="750"}

### MU table

```{r print-react-MU}
data |>
  reactable(
    bordered = TRUE,
    highlight = TRUE,
    striped = TRUE,
    searchable = TRUE,
    compact = TRUE, # compact the table height
    fullWidth = T, # don't fill the page
    defaultPageSize = 20,
    wrap = TRUE,
    defaultSorted = list(muGames = "desc"),
    # filterable = TRUE,
    defaultColDef = colDef(
      style = list(fontFamily = "Roboto", fontSize = "13px"), align = "center"
      # minWidth = 120,
      ),
    columns = list(
      playerDeck   = colDef(name = "Player",minWidth = 120, style = list(fontSize = "11px", fontWeight = "bold", color="black") ),
      opponentDeck = colDef(name = "Opponent"  ,minWidth = 120, style = list(fontSize = "11px", fontWeight = "bold", color="black")),
      muWin    = colDef(name = "#Win" ), # , style = list( fontSize = "13px")
      muGames  = colDef(name = "#Games",defaultSortOrder = "desc"),
      muWR  = colDef(
        name = "Win Rate",
        # defaultSortOrder = "desc",
        cell = function(value) {
          label <- paste0(round(value * 100,1), "%")
          bar_chart_pos_neg(label, value)
          },
        align = "center",
        minWidth = 200
        ),
      playrate = colDef(name = "Player PlayRate",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ),
      factions = colDef(name = "Regions"),
      CI       = colDef(name = "CI",minWidth = 120, style = list(fontSize = "13px")),
      LCI       = colDef(show=F), # lower
      UCI       = colDef(show=F), # lower
      direction = colDef(show=F),
      okCI      = colDef(show=F),
      mirror    = colDef(show=F),
      opponentPR = colDef(name = "Opponent PlayRate",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") )
      )
    )
```

## Row

### Box MU

```{r}
nGames = MUtbl |> 
  # filter( muGames > params$minMUGames ) |>
  summarise(n = sum(muGames)) |>
  pull()

flexdashboard::valueBox(glue::glue("{nGames} Ranked Games"),
                        caption = glue::glue("out of a total of {NROW(LoR.Melt.Matches.RMD)} - min 10 games"),
                        icon = "fa-table",
                        color = "#FA7404")
```

### Last Update

```{r last-update}
LastUpdate.box
```

<!-- # Plat+ {data-icon="fa-table"} -->

<!-- ```{r prepare-data-2} -->

<!-- #' Additional tbl -->

<!-- #' contain the a second DT -->

<!-- #' can be Plat+, or Diamond depending on my current project -->

<!-- #'######################################################### -->

<!-- LoR.Melt.Extra.RMD <- LoR.Diamond.DT.RMD |> -->

<!--   filter( game_type == "Ranked"  ) |> -->

<!--   filter( game_start_time_utc >= as.POSIXct(params$start,"UTC") & game_start_time_utc < as.POSIXct(params$end,"UTC") ) |> -->

<!--   select( -ends_with("_3"),-ends_with("_4")  ) |> -->

<!--   left_join(LoR.Deck.RMD[,.(deck_code,playerDeck_1=archetype)],  by=c("deck_code_1"="deck_code")) |> -->

<!--   left_join(LoR.Deck.RMD[,.(deck_code,opponentDeck_1=archetype)],by=c("deck_code_2"="deck_code")) |> -->

<!--   mutate( playerDeck_2 = opponentDeck_1, opponentDeck_2 = playerDeck_1 ) |> -->

<!--   pivot_longer(cols = c(ends_with("_1"),ends_with("_2")), -->

<!--                names_to = c(".value"), -->

<!--                names_pattern = "(.*)_[0-9]" -->

<!--                ) -->

<!-- # LoR.Melt.Extra.RMD |> -->

<!-- #   filter( playerDeck == "Vi/Viktor - Shellfolk" ) |> -->

<!-- #   tabyl(deck_code) |> -->

<!-- #   arrange(desc(n)) -->

<!-- ``` -->

<!-- ```{r process-MU-extra} -->

<!-- #' WR tbl -->

<!-- #'####### -->

<!-- WR.DT.extra <- LoR.Melt.Extra.RMD |> -->

<!--   filter(game_outcome!="tie") |> -->

<!--   select( playerDeck,opponentDeck,game_outcome ) |> -->

<!--   group_by(playerDeck) |> -->

<!--   summarise(  -->

<!--     nWin   = sum(game_outcome=="win"), -->

<!--     nGames = n(), -->

<!--     WR=mean(game_outcome=="win") -->

<!--   ) |> -->

<!--   ungroup() |> -->

<!--   mutate( playrate = nGames/sum(nGames) ) |> -->

<!--   as.data.table() -->

<!-- #' MU tbl the date is already filtered -->

<!-- #'#################################### -->

<!-- MUtbl.extra <- LoR.Melt.Extra.RMD |> -->

<!--   filter( game_outcome != "tie" ) |> -->

<!--   select( playerDeck,opponentDeck,game_outcome,server,game_version,factions ) |> -->

<!--   group_by(playerDeck,opponentDeck,factions) |> -->

<!--   summarise(  -->

<!--     muWin   = sum(game_outcome=="win"), -->

<!--     muGames = n(), -->

<!--     muWR=mean(game_outcome=="win") -->

<!--   ) |> -->

<!--   ungroup() |> -->

<!--   filter(muGames >= params$minMUGames) |> -->

<!--   mutate( -->

<!--     factions = map_chr(.x = factions, ~str_remove_all(.x, paste(c("_Name","faction_", ""), collapse = "|") ) ), -->

<!--     CI   = map2_df(.x=muWin,.y = muGames, .f = ~binom::binom.confint(.x,.y,0.95,methods="exact")[,c("lower","upper")] ) -->

<!--   ) |> -->

<!--   chop(CI) |> -->

<!--   unnest(CI) |> -->

<!--   mutate(  -->

<!--     okCI = map2_lgl(.x = lower,.y = upper, ~ !between(0.50,.x,.y) ) , -->

<!--     direction = ifelse(muWR>0.50,"POS","NEG"), -->

<!--     direction = replace(direction,direction==0.50,"TIE"), -->

<!--     CI := glue::glue("({scales::percent(lower,accuracy = 0.1)}-{scales::percent(upper,accuracy = 0.1)})" ), -->

<!--     mirror = ifelse(playerDeck==opponentDeck,"Yes","No" ) -->

<!--   ) |> -->

<!--   # removing ~extra variables -->

<!--   select(-lower,-upper) |> -->

<!--   left_join(WR.DT.extra[,.(playerDeck,playrate)],by="playerDeck") |> -->

<!--   left_join(WR.DT.extra[,.(playerDeck,opponentPR=playrate)],by=c("opponentDeck"="playerDeck") ) |> -->

<!--   relocate(factions,.after = muWR) -->

<!-- ``` -->

<!-- ## Inputs {.sidebar} -->

<!-- ### Filters -->

<!-- ```{r filters-extra} -->

<!-- data.extra <- crosstalk::SharedData$new( MUtbl.extra ) -->

<!-- crosstalk::filter_select("playerDeck", "Player's Deck", data.extra, ~playerDeck) -->

<!-- crosstalk::filter_select("opponentDeck", "Opponent's Deck", data.extra, ~opponentDeck) -->

<!-- crosstalk::filter_slider("muWin",   "#Win",  data.extra, ~muWin,   step = 50 ,min = 0) -->

<!-- crosstalk::filter_slider("muGames", "#Games",data.extra, ~muGames, step = 100,min = 0) -->

<!-- crosstalk::filter_slider("muWR", "WinRate", data.extra, ~muWR,step=0.01,min = 0,max = 1) -->

<!-- crosstalk::filter_slider("playrate", "Player PlayRate", data.extra, ~playrate,step=0.01,min = 0,max = round(max(MUtbl$playrate),4) ) -->

<!-- crosstalk::filter_slider("opponentPR", "Opponent PlayRate", data.extra, ~opponentPR,step=0.01,min = 0,max = round(max(MUtbl$opponentPR),4) ) -->

<!-- crosstalk::filter_select("direction", "MU-Direction", data.extra, ~direction) -->

<!-- crosstalk::filter_checkbox("mirror", "Mirror", data.extra, ~mirror, inline = TRUE) -->

<!-- ``` -->

<!-- ## Row {data-heigth="750"} -->

<!-- ### MU table -->

<!-- ```{r print-react-MU-extra} -->

<!-- data.extra |> -->

<!--   reactable( -->

<!--     bordered = TRUE, -->

<!--     highlight = TRUE, -->

<!--     striped = TRUE, -->

<!--     searchable = TRUE, -->

<!--     compact = TRUE, # compact the table height -->

<!--     fullWidth = T, # don't fill the page -->

<!--     defaultPageSize = 20, -->

<!--     wrap = TRUE, -->

<!--     defaultSorted = list(muGames = "desc"), -->

<!--     # filterable = TRUE, -->

<!--     defaultColDef = colDef( -->

<!--       style = list(fontFamily = "Roboto", fontSize = "13px"), align = "center" -->

<!--       # minWidth = 120, -->

<!--       ), -->

<!--     columns = list( -->

<!--       playerDeck   = colDef(name = "Player",minWidth = 120, style = list(fontSize = "11px", fontWeight = "bold", color="black") ), -->

<!--       opponentDeck = colDef(name = "Opponent"  ,minWidth = 120, style = list(fontSize = "11px", fontWeight = "bold", color="black")), -->

<!--       muWin    = colDef(name = "#Win" ), # , style = list( fontSize = "13px") -->

<!--       muGames  = colDef(name = "#Games",defaultSortOrder = "desc"), -->

<!--       muWR  = colDef( -->

<!--         name = "Win Rate", -->

<!--         # defaultSortOrder = "desc", -->

<!--         cell = function(value) { -->

<!--           label <- paste0(round(value * 100,1), "%") -->

<!--           bar_chart_pos_neg(label, value) -->

<!--           }, -->

<!--         align = "center", -->

<!--         minWidth = 200 -->

<!--         ), -->

<!--       playrate = colDef(name = "Player PlayRate",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ), -->

<!--       factions = colDef(name = "Regions"), -->

<!--       CI       = colDef(name = "CI",minWidth = 120, style = list(fontSize = "13px")), -->

<!--       LCI       = colDef(show=F), # lower -->

<!--       UCI       = colDef(show=F), # lower -->

<!--       direction = colDef(show=F), -->

<!--       okCI      = colDef(show=F), -->

<!--       mirror    = colDef(show=F), -->

<!--       opponentPR = colDef(name = "Opponent PlayRate",format = colFormat(percent = TRUE,digits = 1), style = list( fontSize = "13px") ) -->

<!--       ) -->

<!--     ) -->

<!-- ``` -->

<!-- ## Row -->

<!-- ### Box MU -->

<!-- ```{r} -->

<!-- nGames.extra = MUtbl.extra |>  -->

<!--   # filter( muGames > params$minMUGames ) |> -->

<!--   summarise(n = sum(muGames)) |> -->

<!--   pull() -->

<!-- flexdashboard::valueBox(glue::glue("{nGames.extra} Ranked Games"), -->

<!--                         caption = glue::glue("out of a total of {NROW(LoR.Melt.Extra.RMD)} - min 10 games"), -->

<!--                         icon = "fa-table", -->

<!--                         color = "#FA7404") -->

<!-- ``` -->

<!-- ### Last Update -->

<!-- ```{r} -->

<!-- LastUpdate.box -->

<!-- ``` -->

# Grid {data-icon="fa-file-image"}

## Row {data-heigth="850"}

### MU Grid

```{r get-WR-Top}
# Last 7 days most played
TopCC <- LoR.Melt.Matches.RMD |>
  filter( game_start_time_utc >= now()-days(7) ) |>
  count(playerDeck) |>
  slice_max(n, n = params$nGrid ) |> 
  select(playerDeck) |>
  pull()

# WRTopCC <- tibble::tibble(
#   playerDeck = rep(TopCC,each=params$nGrid),
#   opponentDeck = rep(TopCC,params$nGrid)
#   ) |>
#   left_join(MUtbl.extra, by = c("playerDeck","opponentDeck"))
```

```{r mu-master}
MUtbl.Master <- tibble::tibble( 
  playerDeck = rep(TopCC,each=params$nGrid),
  opponentDeck = rep(TopCC,params$nGrid)
  ) |> 
  left_join( MUtbl, by = c("playerDeck","opponentDeck")) |>
  mutate( muWR = replace(muWR, muGames < 30, NA ) )
```

```{r create-grid}
grid <- matrix(MUtbl.Master$muWR,
               nrow = params$nGrid,
               ncol = params$nGrid, byrow = T)
diag(grid) <- NA
colnames(grid) <- TopCC

grid.plus <- matrix(MUtbl.Master$CI,
                    nrow = params$nGrid,
                    ncol = params$nGrid, byrow = T)
diag(grid.plus) <- NA
colnames(grid.plus) <- sprintf("%s.v2",TopCC)

grid.plus <- grid.plus |>
  as.data.table()

grid.all <- cbind(grid,grid.plus)
```

```{r gt-grid,fig.width=12, fig.height=10}
MUgrid.gt <- grid.all |>
  as.data.table() |>
  add_column( name = colnames(grid),.before = 1 ) |>
  rename(" "=1) |>
  gt() |>
  gtExtras::gt_color_rows(2:(params$nGrid+1),
                # palette = c("#D73027", "white", "#1A9850" ),
                palette = c("red", "white", "green"),
                use_paletteer = F,
                domain = c(0,1) ) |>
  fmt_percent(
    columns = 2:(params$nGrid+1),
    decimals = 1
  )


for (i in 1:params$nGrid ) {
  
  # MUgrid.gt <- MUgrid.gt |>
  #   gtExtras::gt_merge_stack(col1 = !!TopCC[i], col2 = !!sprintf("%s.v2",TopCC[i]) )
  
  MUgrid.gt <- MUgrid.gt |>
    cols_merge(
      columns = c(i+1,params$nGrid+i+1),
      hide_columns = (params$nGrid+i+1),
      # pattern = "{1}&mdash;{2}"
      ) |>
    text_transform(
      locations = cells_body(
        columns = (i+1)
        ),
      fn = function(x){
        percent <- word(x, 1)
        frac <- word(x, -1)
        glue::glue(
          #595959 #grey35 / #7f7f7f #grey50
          "<div style='line-height:12px'><span style='font-weight:bold;color:#595959;font-variant:small-caps;font-size:14px'>{percent}</div>
           <div style='line-height:10px'><span style='color:#7f7f7f;font-size:10px'>{frac}</span></div>"
        )
        }
      )
  
}

MUgrid.gt.final <- MUgrid.gt |>
  cols_align(
    align = "center",
    columns = -1
  ) |>
  tab_options(
    data_row.padding = px(3.5),
    table.font.size = px(12)
  ) |>
  cols_width(
    -1 ~ px(90),
     1 ~ px(120),
    # everything() ~ px(90)
  ) |>
  opt_table_font(
    font = "Chivo"
  ) |>
  tab_source_note(
  source_note = md(glue::glue("MatchUp values from Ranked games with Seasonal players from Between Worlds Season.
                              Order of the Archetypes based on the playrate.
                              Source: Metadata of games collected with RiotGames API")
  ))

# Order of the Archetypes based on the playrate over the last 7 days from the end of the Between Worlds Season
# gtsave(MUgrid.gt.final,glue::glue("./images/mugrid_218_220.png"), vwidth = 1500, vheight = 1000) |> invisible()

MUgrid.gt.final |>
  tab_options(
    data_row.padding = px(5),
    table.font.size = px(13),
    column_labels.font.size = px(10)
  ) |>
  cols_width(
    -1 ~ px(90),
     1 ~ px(150),
    # everything() ~ px(100)
  )
```

```{r save-gt-grid,fig.width=12, fig.height=8}
gtsave(data = MUgrid.gt.final,
       filename = "mugrid.png",
       path = file.path("./images"),
       # path = "images",
       vwidth = 1500, vheight = 1000
       ) |> invisible()

gtsave(data = MUgrid.gt.final,
       filename = "mugrid.png",
       path = file.path("C:/Users/Valentino Vazzoler/Documents/R/llorr-website/static/images/"),
       # path = "images",
       vwidth = 1500, vheight = 1000
       ) |> invisible()


# flextable::save_as_image(x = ft, path = "images/mugrid.png") |> invisible()
```

## Row

### BOX GRID

```{r value-nGames-2}
# glue::glue(
#           #595959 #grey35 / #7f7f7f #grey50
#           "<div style='line-height:12px'><span style='font-weight:bold;color:#595959;font-variant:small-caps;font-size:14px'>{percent}</div>
#            <div style='line-height:10px'><span style='color:#7f7f7f;font-size:10px'>({frac})</span></div>"
#         )

# totalRanked <- length(unique(c(LoR.Melt.Matches.RMD$match_key,LoR.Melt.Extra.RMD$match_key)))*2

flexdashboard::valueBox(glue::glue("{nGames} Ranked Games"),
                        caption = glue::glue("out of a total of {NROW(LoR.Melt.Matches.RMD)} - min 10 games"),
                        icon = "fa-table",
                        color = "#FA7404")

# flexdashboard::valueBox(glue::glue("{nGames} Master games / {nGames.extra} Last-Seasona Master(~Plat+) games"),
#                         caption = glue::glue("out of a total of {totalRanked} games - min 10 games"),
#                         icon = "fa-table",
#                         color = "#FA7404")
```

### Last Update

```{r}
LastUpdate.box
```

<!-- ![](images/mugrid.png) -->

```{r}
# knitr::include_graphics(path = "./images/mugrid.png")
```

# Grid 2.18/2.20 (Between Worlds) {data-icon="fa-file-image"}

![](images/mugrid_218_220.png)

# Downloads and Informations {data-orientation="columns" data-icon="fa-info-circle"}

## Download {data-width="200"}

### Match Ups Data

```{r}
# MUtbl |>
#   filter( muGames > 10 ) |>
#   select(playerDeck,opponentDeck,muWin,muGames,muWR) |>
#   fwrite("mutbl_patch_2_12to13.csv")
```

```{r download-master}
# MUtbl |>
#   # filter( muGames > 10 ) |>
#   select(playerDeck,opponentDeck,muWin,muGames,muWR) |>
#   downloadthis::download_this(
#     button_label = "Download MU (Master) data as .csv",
#     output_name = "mutable",
#     button_type = "success",
#     has_icon = TRUE,
#     icon = "fa fa-save"
#     )
# 
# MUtbl |>
#   # filter( muGames > 10 ) |>
#   select(playerDeck,opponentDeck,muWin,muGames,muWR) |>
#   jsonlite::write_json("MU.json")
```

```{r download-extrs}
# MUtbl.extra |>
#   select(playerDeck,opponentDeck,muWin,muGames,muWR) |>
#   downloadthis::download_this(
#     button_label = "Download MU (~Plat+)  data as .csv",
#     output_name = "mutable",
#     button_type = "success",
#     has_icon = TRUE,
#     icon = "fa fa-save"
#     )

# MUtbl |>
#   # filter( muGames > 10 ) |>
#   select(playerDeck,opponentDeck,muWin,muGames,muWR) |>
#   jsonlite::write_json("MU.json")
```

<!-- ### Match Ups Data (2.12/2.13) -->

<!-- ```{r} -->

<!-- # MUtbl |> -->

<!-- #   filter( muGames > 10 ) |> -->

<!-- #   fwrite( "data/mutbl_patch_2_12to13.csv" ) -->

<!-- fread("data/mutbl_patch_2_12to13.csv") |> -->

<!--   select(playerDeck,opponentDeck,muWin,muGames,muWR) |> -->

<!--   download_this(., -->

<!--               button_label = "Download MU data (2.12/2.13) as .csv", -->

<!--               output_name = "mutable", -->

<!--               button_type = "success", -->

<!--               has_icon = TRUE, -->

<!--               icon = "fa fa-save" -->

<!--               ) -->

<!-- ``` -->

### Match Ups Grid

```{r}
downloadthis::download_file(
  path = file.path("images/mugrid.png"),
  # path = system.file("assets/css/all.min.css", package = "downloadthis"),
  button_label = "Download MU grid as .png",
  button_type = "primary",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```

### Match Ups Grid (2.18/2.20)

```{r}
downloadthis::download_file(
  path = file.path("images/mugrid_218_220.png"),
  # path = system.file("assets/css/all.min.css", package = "downloadthis"),
  button_label = "Download MU grid (2.18/2.20) as .png",
  button_type = "primary",
  has_icon = TRUE,
  icon = "fa fa-save",
  self_contained = FALSE
)
```

## Column {data-width="800"}

### How to use

#### Filters

The format of the table is the usual way I display the match-ups data but I also displayed additional variables that I normally remove in the report:

-   **Player's Deck** - deck's archetype of the playerDeck

-   **Opponent's Deck** - deck's archetype of the opponentDeck

-   **#Win** - min number of wins for a match-up

-   **#Games** - min number of games for a match-up

-   **Regions** - regions of the 'Player' deck.

-   **MU-Direction** - simply if the MU is positive (win rate > 50%) or negative (win rate \< 50%) for the 'Player' or tie (win rate = 50%)

-   **Mirror** - hide or include mirror match-ups

#### Archetypes Fix

```{r gt-archetype}
source(file.path("C:","LlorR","scripts","functions","lor_archetype_gt.R"))
gtfix
```

#### General info

When I refer to games it's always refering a single playerDeck. So, if I have the information of 1 match it's equivalent to 2 games.

#### Credits

Special thanks to bA1ance and Pavelicii for the recent support \^\^

```{r update-Shiny}
# Top30CC <- WR.DT.extra |>
#   slice_max(playrate,n=30) |>
#   pull(playerDeck)
# 
# MUtbl.extra |>
#   filter(playerDeck %in% Top30CC & opponentDeck %in% Top30CC ) |>
#   fwrite(file.path("C:","LlorR","scripts","shiny","bo3-helper","Bandle01-MUtbl.csv"))


# WR.DT |>
#   fwrite(file.path("C:","LlorR","data","raw","S10","WRtbl_S10_218_220.csv"))
# 
# MUtbl |>
#   fwrite(file.path("C:","LlorR","data","raw","S10","MUtbl_S10_218_220.csv"))
```
