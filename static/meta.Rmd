---
title: "Meta & Decks (from Patch 3.17 - The Darkin Saga - Domination)"
author: "by Legna"
base_url: https://www.llorr-stats.com
output:
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-trophy", text: "MatchUps", href: "https://www.llorr-stats.com/static/mu.html", align: right }
      - { icon: "fa-home", href: "https://www.llorr-stats.com", align: right }
    orientation: row
    vertical_layout: fill
params:
  start:    "2022-10-12 19:00:00"
  end:      "2099-10-12 19:00:00"
  min_mu_games: 5 # min number of games for a MU
  max_top_pr:  12 # meta evolution decks
  last_season: "S16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo       = FALSE, 
  eval       = TRUE, 
  warning    = FALSE, 
  error      = FALSE, 
  message    = FALSE, 
  comment    = NA, 
  R.options  = list(width = 140, digits.secs=6), 
  dev.args   = list(bg = 'whitesmoke'), 
  fig.align  = 'center', 
  fig.width  = 12, 
  fig.height = 8, 
  fig.path   = glue::glue("images/"), 
  layout     = "l-page", 
  preview    = TRUE
)

#' R Option
options(scipen = 999)
source(file.path("C:", "LlorR", "scripts", "lor_main.R"))
source(file.path("C:", "LlorR", "scripts", "functions", "lor_constants.R"))
source(file.path("C:", "LlorR", "scripts", "functions", "lor_functions.R"))
xaringanExtra::use_panelset()
```

```{css}
.value-box {
  height: 100px;
}
```

```{r constants}
last_update_box <- flexdashboard::valueBox(
  Sys.Date(), 
  caption = glue::glue("Last Update / Usually done around 5:00 UTC / 7:00 CET"), 
  icon = "fa-clock", 
  color = "#1A9850"
)

seq_date <- seq(lubridate::as_datetime(params$start), floor_date(lubridate::now(), unit = "day")+hours(18) , "day") #
```

```{r load-data}
# load DeckDT
LoR_Deck_RMD       <- fread(file.path("C:", "LlorR", "data", "raw", "LoR_DECK.csv"), na.strings = c("", NA), colClasses = "character")

# load Account
LoR_Account_RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)ACCOUNT(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread, colClasses = "character", header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(activeShard = if_else(activeShard %in% c("sea", "asia"), "apac", activeShard) ) |>
  mutate(RiotID = glue::glue("{gameName}#{tagLine}")) |>
  # to be safe
  distinct(puuid, .keep_all = T)

# load Games
LoR_Match_DT_RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)Match_DT_{params$last_season}(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread, header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea", "asia"), "apac", server) )

LoR_Diamond_DT_RMD <- list.files(path = file.path("C:", "LlorR", "data", "raw"), pattern = glue("^(.*)Diamond_DT_{params$last_season}(.*)csv$"), full.names = T) |>
  map_dfr(data.table::fread, header = T, na.strings = c("", NA), encoding = "UTF-8") |>
  mutate(server = if_else(server %in% c("sea", "asia"), "apac", server) )
```

```{r deck-fix}
# LoR_Deck_RMD <- archetype_pretty(LoR_Deck_RMD)
LoR_Deck_RMD <- update_and_save_deck(
  LoR_Deck_RMD, 
  bind_rows(LoR_Match_DT_RMD, LoR_Diamond_DT_RMD)
)
LoR_Deck_RMD[ !is.na(archetype_pretty), archetype:=archetype_pretty ]
```

```{r prepara-data}
LoR_Melt_Master_RMD <- LoR_Match_DT_RMD |>
  filter(game_type == "Ranked"  ) |>
  filter(str_detect(game_version, "3-10") | game_start_time_utc %within% interval(lubridate::as_datetime(params$start), lubridate::as_datetime(params$end)) ) |>
  melt_match(LoR_Deck_RMD, LoR_Account_RMD)

LoR_Melt_Diamond_RMD <- LoR_Diamond_DT_RMD |>
  filter(game_type == "Ranked"  ) |>
  filter(str_detect(game_version, "3-10") | game_start_time_utc %within% interval(lubridate::as_datetime(params$start), lubridate::as_datetime(params$end)) ) |>
  melt_match(LoR_Deck_RMD, LoR_Account_RMD)

LoR_Melt_Matches_RMD <- LoR_Melt_Master_RMD |>
  bind_rows(LoR_Melt_Diamond_RMD) |>
  # distinct(match_key, playerPuuid, .keep_all = T)
  distinct()
```

Stats (last 7days) {data-icon="fa-table" data-orientation=rows}
================================

```{r}
meta_7days <- reactable_meta(LoR_Melt_Matches_RMD, 7)
```

Row {data-heigth="125"}
-----------------------------------------------------------------------

### Number of Games

```{r}
flexdashboard::valueBox(glue::glue("{meta_7days$nGames} Games"), 
                        caption = glue::glue("Number of Ranked Games - Master&HighDiamond"), 
                        icon = "fa-table", 
                        color = "#a88b32")
```

### Number of Meta Decks

```{r}
flexdashboard::valueBox(glue::glue("{length(meta_7days$fct_meta)} Meta Decks"), 
                        caption = glue::glue("Decks with PlayRate with at least 1%"), 
                        icon = "fa-trophy", 
                        color = "#65c0a9")
```

### Number of Underdog Decks

```{r}
flexdashboard::valueBox(glue::glue("{length(meta_7days$fct_underdog)} Underdog Decks"), 
                        caption = glue::glue("Decks with positive WR and PR in 0.1% to 1%"), 
                        icon = "fa-dog", 
                        color = "#ff7f24")
```

### Last-Update

```{r}
last_update_box
```

Row {data-heigth="875"}
-----------------------------------------------------------------------

### Decks Performances

```{r}
meta_7days$meta_table
```

Meta-Evolution {data-icon="fa-chart-line"}
================================

Row {data-heigth="125"}
-----------------------------------------------------------------------

### Master

```{r value-player-master}
flexdashboard::valueBox(glue::glue("{LoR_Account_RMD[master=='master', .N]}"), 
                        caption = glue::glue("Master Players"), 
                        icon = "fa-medal", 
                        color = "#65c0a9")
```

### Diamond

```{r value-player-diamond}
flexdashboard::valueBox(glue::glue("{LoR_Account_RMD[master=='diamond', .N]}"), 
                        caption = glue::glue("HighDiamond Players"), 
                        icon = "fa-diamond", 
                        color = "#ff7f24")
```

### Last Update

```{r}
last_update_box
```

Row {.tabset}
-----------------------------------------------------------------------

### Master

```{r meta-evo-master, fig.width=20, fig.height=8}
hourly_master_plot <- plot_hourly_meta_deck(data = LoR_Melt_Master_RMD, prev_days = 7, max_top_pr = params$max_top_pr)
hourly_master_line <- plot_playrate_by_time(data = LoR_Melt_Master_RMD, prev_days = 7, max_top_pr = params$max_top_pr)
hourly_master_double <- invisible(hourly_master_plot + hourly_master_line)

hourly_master_double

# ggsave(filename = "images/meta-evo-master.png", plot = hourly_master_double, width = 12, height = 8) |> invisible()
```

### Diamond

```{r meta-evo-diamond, fig.width=20, fig.height=8}
hourly_diamond_plot <- plot_hourly_meta_deck(data = LoR_Melt_Diamond_RMD, prev_days = 7, max_top_pr = params$max_top_pr, population = "Diamond")
hourly_diamond_line <- plot_playrate_by_time(data = LoR_Melt_Diamond_RMD, prev_days = 7, max_top_pr = params$max_top_pr, population = "Diamond")
hourly_diamond_double <- invisible(hourly_diamond_plot + hourly_diamond_line)

hourly_diamond_double

# ggsave(filename = "images/meta-evo-diamond.png", plot = hourly_diamond_double, width = 12, height = 8) |> invisible()
```

Stats (whole patch) {data-icon="fa-table"}
================================

```{r}
meta_all <- reactable_meta(LoR_Melt_Matches_RMD)
```

Row 
-----------------------------------------------------------------------

### Number of Games

```{r value-games}
# {data-heigth="125"}
nGames <- NROW(LoR_Melt_Matches_RMD)

flexdashboard::valueBox(glue::glue("{meta_all$nGames} Games"), 
                        caption = glue::glue("Number of Ranked Games - by Seasonal Players"), 
                        icon = "fa-table", 
                        color = "#a88b32")
```

### Number of Meta Decks

```{r value-meta}
flexdashboard::valueBox(glue::glue("{length(meta_all$fct_meta)} Meta Decks"), 
                        caption = glue::glue("Decks with PlayRate with at least 1%"), 
                        icon = "fa-trophy", 
                        color = "#65c0a9")
```

### Number of Underdog Decks

```{r value-underdog}
flexdashboard::valueBox(glue::glue("{length(meta_all$fct_underdog)} Underdog Decks"), 
                        caption = glue::glue("Decks with positive WR and PR in 0.1% to 1%"), 
                        icon = "fa-dog", 
                        color = "#ff7f24")
```

### Last Update

```{r}
last_update_box
```

Row {data-heigth="875"}
-----------------------------------------------------------------------

### Decks Performances

```{r stats-all}
meta_all$meta_table
```

Fresh Stats (last 24 hours) {data-icon="fa-table"}
================================

Row {data-heigth="125"}
-----------------------------------------------------------------------

### Time Frame

```{r}
flexdashboard::valueBox(glue::glue("24 Hours Time Frame"), 
                        caption = glue::glue("from {Sys.Date()+hours(18)-days(2)} to {Sys.Date()+hours(18)-days(1)}"), 
                        icon = "fa-clock", 
                        # color = "lightgreen"
                        color = "red")
```


### Last Update

```{r}
last_update_box
```

```{r}
LoR_Melt_24hrs <- LoR_Melt_Matches_RMD |>
  filter(game_start_time_utc %within% interval(today()+hours(18)-days(2), today()+hours(18)-days(1)) ) |>
  distinct(match_key, playerPuuid, .keep_all = T)
```

Row {data-heigth="875"}
-----------------------------------------------------------------------

### Previous Day

```{r 24hrs-process-winRate}
if (NROW(LoR_Melt_24hrs)>0) {
  
  WR_tbl_24h <- LoR_Melt_24hrs |>
  win_rates(details = T, server = F) |>
  filter(playerDeck %!in% c(meta_7days$fct_meta, meta_all$fct_meta, meta_7days$fct_underdog, meta_all$fct_underdog) ) |>
  filter(WR > 0.5 ) |>
  slice_max(nGames, n = 50, with_ties = F) |>
  select(-lower, -upper)

deck_code_tbl_24hrs  <- LoR_Melt_24hrs |>
  filter(playerDeck %in% c(WR_tbl_24h$playerDeck) ) |>
  mutate(playerDeck = factor(playerDeck, ordered = TRUE, 
                              levels = c(WR_tbl_24h$playerDeck) )
         ) |>
  group_by(server, playerDeck, deck_code ) |>
  summarise( n = n() ) |>
  group_by(playerDeck) |>
  slice_max(n, n = 10) |>
  ungroup() |>
  mutate(link = glue::glue("<a href='https://runeterra.ar/decks/code/{deck_code}'>{deck_code}</a>"), 
         server = str_to_title(server) ) |>
  select(playerDeck, n, link, server)
  
with_tooltip <- function(value, tooltip) {
  htmltools::tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help", 
            title = tooltip, value)
}

WR_tbl_24h |>
  reactable(
    # groupBy = "playerDeck", 
    searchable = TRUE, 
    bordered = TRUE, 
    # wrap = FALSE, 
    highlight = TRUE, 
    striped = TRUE, 
    pagination = FALSE, 
    fullWidth = T, 
    # defaultSorted = list(LMI = "desc"), 
    defaultColDef = colDef(
      align = "center", 
      minWidth = 100, 
      # headerStyle = list(background = "steelblue", color="white")
    ), 
    details = function(index) {
      # index = 1
      deckdata <- deck_code_tbl_24hrs[ deck_code_tbl_24hrs$playerDeck == WR_tbl_24h$playerDeck[index], ]
      reactable(
        deckdata, 
        fullWidth = F, 
        defaultColDef = colDef(
          style = list( fontSize = 13 ), 
          html = TRUE
          ), 
        theme = reactableTheme(
          headerStyle = list(background = "red", color="white", fontSize = 13), 
          rowStyle = list(height = "45px")
        ), 
        columns = list(
          n = colDef(name = "#Games", minWidth = 75 ), 
          link = colDef(name = "DeckCode - Most played lists", minWidth = 750, style = list( fontSize = 9 ) ), 
          # playerDeck = colDef(name = "Archetype", minWidth = 150 ), 
          playerDeck = colDef(show = F), 
          server = colDef(name = "Server", minWidth = 100 )
          ) )}, 
    columns = list(
      playerDeck = colDef(name = "Archetype", minWidth = 250, align = "left", header = with_tooltip("Archetype", "I still have to decide what to display here, so for now I'll simply but the decks with at least 10 games, before WR that did't appear in the other sections (whole-Patch and 7days).")), 
      nWin   = colDef(name = "#Win"), 
      nGames = colDef(name = "#Games"), 
      playrate = colDef(name = "PlayRate", format = colFormat(percent = TRUE, digits = 1) ), 
      type = colDef(name = "Type"), 
      # LMI = colDef(name = "LMI"), 
      tier = colDef(name = "Tier", minWidth = 200, align = "left"), 
      CI = colDef(name = "Conf.Interval", minWidth = 200, align = "center"), 
      WR = colDef(name = "WinRate", format = colFormat(percent = TRUE, digits = 1) )
    )

  )

}
```

Downloads and Informations {data-orientation="columns" data-icon="fa-info-circle"}
================================

Column {data-width="450"}
-----------------------------------------------------------------------

### Archetypes Guide

current aggregations applied to archetypes (Champions+Regions)

```{r archetype}
tbl_archetype
```

Column {data-width="550"}
-----------------------------------------------------------------------

### LMI - Tiers

```{r info-gt-lmi}
tribble( 
  ~Tier, ~Note, 
  "Best Choice ~ T0", "with LMI >= 97.5", 
  "Good ~T1", "with LMI in [85, 97.5)", 
  "Could do better ~T2", "with LMI in [50, 85)", 
  "Meh, either bad or not played/ignored ~T3", "with LMI < 50"
  ) |>
  gt() |>
  tab_header(
    title = glue::glue("LMI Tiers")
  ) |>
  gtExtras::gt_theme_nytimes()
```

### Donwload - Master

```{r}
downloadthis::download_file(
  path = file.path("images/meta-evo-master-1.png"), 
  # path = system.file("assets/css/all.min.css", package = "downloadthis"), 
  button_label = "Download PlayRates over time as .png", 
  button_type = "primary", 
  has_icon = TRUE, 
  icon = "fa fa-save", 
  self_contained = FALSE
)
```

### Donwload - Diamond

```{r}
downloadthis::download_file(
  path = file.path("images/meta-evo-diamond-1.png"), 
  # path = system.file("assets/css/all.min.css", package = "downloadthis"), 
  button_label = "Download PlayRates over time as .png", 
  button_type = "primary", 
  has_icon = TRUE, 
  icon = "fa fa-save", 
  self_contained = FALSE
)
```


### General info

When I refer to games it's always refering a single playerDeck. So, if I have the information of 1 match it's equivalent to 2 games.
